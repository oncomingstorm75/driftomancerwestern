<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Western RPG Charactermancer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Creepster&display=swap');

        :root {
            --primary-bg: linear-gradient(135deg, #2c1a0e 0%, #4c301c 50%, #6e482a 100%);
            --section-bg: rgba(44, 26, 14, 0.7);
            --border-color: #5a3d2e;
            --accent-gold: #c98e2a;
            --text-light: #d8c29e;
            --text-dark: #4c301c;
            --bg-light: #f5f5dc;
            --glow-yellow: #ffeb3b;
            --glow-orange: #ff9800;
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --shadow-gold: rgba(201, 142, 42, 0.5);
        }

        body {
            font-family: 'Cinzel', serif;
            background: var(--primary-bg);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="parchment" width="100" height="100" patternUnits="userSpaceOnUse"><rect width="100" height="100" fill="%23f5f5dc"/><path fill="%23d4c3a1" d="M0 0h100v100h-100zM100 0L0 100l100 100V0z"/></pattern></defs><rect width="100" height="100" fill="url(%23parchment)"/></svg>') repeat;
            opacity: 0.1;
            z-index: -1;
        }

        h1 {
            text-align: center;
            color: var(--accent-gold);
            text-shadow: 0 0 5px var(--glow-yellow), 0 0 10px var(--glow-orange);
            font-size: clamp(2em, 5vw, 3em);
            font-family: 'Creepster', cursive;
            margin-bottom: 10px;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            0% { text-shadow: 0 0 5px var(--accent-gold), 0 0 10px var(--accent-gold); }
            100% { text-shadow: 0 0 10px var(--glow-yellow), 0 0 20px var(--glow-orange); }
        }

        .subtitle {
            text-align: center;
            color: #F4A460;
            margin-bottom: 20px;
            font-style: italic;
        }

        section {
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: inset 0 0 15px var(--shadow-dark), 0 0 10px var(--shadow-gold);
            position: relative;
        }

        h2 {
            color: var(--text-light);
            text-align: center;
            text-shadow: 1px 1px 2px #000;
            border-bottom: 2px dashed var(--accent-gold);
            padding-bottom: 10px;
            font-size: 2em;
            margin-top: 0;
        }

        h3 {
            color: var(--text-light);
            border-bottom: 1px dashed var(--accent-gold);
            padding-bottom: 5px;
        }

        select, input, textarea, button {
            background: var(--bg-light);
            border: 1px solid #4c301c;
            border-radius: 5px;
            padding: 8px;
            margin: 5px;
            font-family: inherit;
            color: var(--text-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 5px var(--shadow-gold);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            width: 100%;
        }

        button {
            background: linear-gradient(var(--accent-gold), #a3721e);
            color: var(--text-dark);
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            border: none;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(var(--glow-yellow), var(--accent-gold));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden { display: none; }

        .roll-display {
            color: var(--glow-yellow);
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }

        .char-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .char-input-group label { flex: 1; font-weight: bold; }

        .char-input-group input { flex: 2; }

        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .skill-item {
            border: 1px solid var(--accent-gold);
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            position: relative;
        }

        .skill-item.archetype-skill { border-color: #5d9d7b; }

        .skill-item.occupation-skill { border-color: #9d5d5d; }

        .skill-item-title {
            font-weight: bold;
            color: #f5e7c8;
            font-size: 0.9em;
        }

        .skill-input-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .skill-label {
            font-size: 0.8em;
            color: #b8a07c;
            font-style: italic;
        }

        .skill-input {
            width: 40px;
        }

        .talent-grid, .hindrance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 10px;
        }

        .talent-item, .hindrance-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            padding: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .talent-name, .hindrance-name {
            cursor: pointer;
            font-weight: bold;
            color: #f5e7c8;
            transition: color 0.2s;
        }

        .talent-name:hover, .hindrance-name:hover {
            color: var(--glow-yellow);
        }

        .talent-description, .hindrance-description {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
        }

        .points-summary {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .points-summary p {
            margin: 5px 0;
            font-weight: bold;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="number"] {
            width: 60px;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        ul li {
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            section { padding: 15px; }
            .skill-grid { grid-template-columns: 1fr; }
            .talent-grid, .hindrance-grid { grid-template-columns: 1fr; }
            .char-input-group { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <h1>Western RPG Charactermancer</h1>
    <p class="subtitle">Made for Rollingdeadly's The Quick and the Dead</p>

    <section id="step1">
        <h2>Step 1: Choose your Western Archetype</h2>
        <select id="archetype-select" aria-label="Select your character's archetype">
            <option value="">Select an Archetype...</option>
        </select>
        <button onclick="selectArchetype()">Saddle Up - Next</button>
    </section>

    <section id="step2" class="hidden">
        <h2>Step 2: Choose your Occupation</h2>
        <select id="occupation-select" aria-label="Choose an occupation">
            <option value="">Select an Occupation...</option>
        </select>
        <button onclick="selectOccupation()">Next</button>
        <button onclick="prevStep(1)">Back</button>
    </section>

    <section id="step3" class="hidden">
        <h2>Step 3: Generate Characteristics</h2>
        <p>Core Characteristic: <select id="core-char-select" aria-label="Select core characteristic" onchange="updateCharacteristicInputs()"></select></p>
        <p class="roll-display">Core Roll: <span id="core-roll-display">Not rolled yet</span></p>
        <button onclick="rollCore()">Roll Core</button>
        <p>Total points: 460 + Core. Allocate to: STR, CON, DEX, POW, APP, EDU, INT, SIZ (Min 15, Max 130)</p>
        <div id="char-alloc"></div>
        <p>Remaining Points: <span id="remaining-points">460</span></p>
        <button onclick="completeChars()">Next</button>
        <button onclick="prevStep(2)">Back</button>
    </section>

    <section id="step4" class="hidden">
        <h2>Step 4: Choose Age & Apply Modifiers</h2>
        <select id="age-select" onchange="toggleDeduct()" aria-label="Select age">
            <option value="18-21">18-21: Deduct 5 total among STR, CON, DEX. Max Luck 90.</option>
            <option value="22-39">22-39: +10 EDU</option>
            <option value="40-49">40-49: +20 EDU, -10 APP, -10 total from STR, CON, DEX</option>
            <option value="50-59">50-59: +30 EDU, -15 APP, -15 total from STR, CON, DEX</option>
            <option value="60-69">60-69: +40 EDU, -20 APP, -20 total from STR, CON, DEX</option>
        </select>
        <div id="age-deduct" class="hidden">
            <p>Distribute total deduction across STR, CON, DEX:</p>
            <label>STR: <input id="deduct-str" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <label>CON: <input id="deduct-con" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <label>DEX: <input id="deduct-dex" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <p>Total Deducted: <span id="total-deduct">0</span>/<span id="required-deduct">0</span></p>
        </div>
        <div id="age-18-21-deduct" class="hidden">
            <p>Distribute 5 points to deduct from STR, CON, DEX:</p>
            <label>STR: <input id="deduct-str-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <label>CON: <input id="deduct-con-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <label>DEX: <input id="deduct-dex-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <p>Total Deducted: <span id="total-deduct-18-21">0</span>/5</p>
        </div>
        <button onclick="applyAge()">Apply & Next</button>
        <button onclick="prevStep(3)">Back</button>
    </section>

    <section id="step5" class="hidden">
        <h2>Step 5: Determine Secondary Attributes</h2>
        <button onclick="rollLuck()">Roll Luck</button>
        <p class="roll-display">Luck: <span id="luck-display">Not rolled yet</span></p>
        <button onclick="calcSecondaries()">Calculate All</button>
        <div id="secondary-display"></div>
        <button onclick="nextStep(6)">Next</button>
        <button onclick="prevStep(4)">Back</button>
    </section>

    <section id="step6" class="hidden">
        <h2>Step 6: Skill Points</h2>
        <p>Based on your choices, here are your total skill points:</p>
        <div class="points-summary">
            <p>Occupation Points: <span id="occ-total">0</span></p>
            <p>Personal Points: <span id="pers-total">0</span></p>
            <p>Archetype Bonus: <span id="arch-total">100</span></p>
        </div>
        <hr>
        <p>Use the inputs below as a scratchpad to help track your skill point allocation.</p>
        <div id="skill-alloc" class="skill-grid"></div>
        <button id="complete-skills-btn" onclick="completeSkills()" disabled>Next</button>
        <button onclick="prevStep(5)">Back</button>
    </section>

    <section id="step7" class="hidden">
        <h2>Step 7: Determine Hindrances and Talents</h2>
        <button onclick="rollNaturalTalent()">Roll Natural Talent</button>
        <p class="roll-display">Natural Talent: <span id="natural-talent">Not rolled yet</span></p>
        <p><strong>Archetype Talent:</strong> <span id="arch-talent"></span></p>
        <h3>Hindrances (Max 5 total, 1 major >4)</h3>
        <div id="hindrance-checkboxes" class="hindrance-grid"></div>
        <p>Hindrances: <span id="selected-hinds">None</span> | Talent Points: <span id="talent-points">0</span></p>
        <h3>Talents (Max 5 total incl. arch/natural, 1 major >4)</h3>
        <div id="talent-checkboxes" class="talent-grid"></div>
        <p>Talents: <span id="selected-tals">None</span></p>
        <button onclick="completeHT()">Next</button>
        <button onclick="prevStep(6)">Back</button>
    </section>

    <section id="step8" class="hidden">
        <h2>Step 8: Create Backstory</h2>
        <label for="name">Name: <input id="name" type="text"></label>
        <label for="gender">Gender: <input id="gender" type="text"></label>
        <label for="description">Personal Description: <textarea id="description"></textarea></label>
        <label for="heritage">Heritage: 
            <select id="heritage">
                <option value="a">a. African American</option>
                <option value="b">b. Far East (Chinese, Japanese, etc.)</option>
                <option value="c">c. European (Irish American, Italian, German...)</option>
                <option value="d">d. Southern (Mexican, Cuban, etc.)</option>
                <option value="e">e. Mysterious (There’s something odd about you...)</option>
            </select>
        </label>
        <label for="ideology">Ideology/Beliefs: <input id="ideology" type="text"></label>
        <label for="significant-people">Significant People: <input id="significant-people" type="text"></label>
        <label for="meaningful">Meaningful Location/Possessions: <input id="meaningful" type="text"></label>
        <label for="traits">Traits: <input id="traits" type="text"></label>
        <label for="madness">Bout of Madness: <textarea id="madness"></textarea></label>
        <label for="hair-eye">Hair/Eye Color: <input id="hair-eye" type="text"></label>
        <label for="marks">Distinguishing Marks: <input id="marks" type="text"></label>
        <button onclick="completeBackstory()">Next</button>
        <button onclick="prevStep(7)">Back</button>
    </section>

    <section id="step9" class="hidden">
        <h2>Step 9: Finalize Character</h2>
        <button onclick="generateSheet()">Generate Sheet & Export</button>
        <button onclick="prevStep(8)">Back</button>
    </section>

    <section id="character-sheet" class="hidden">
        <h3 id="sheet-title"></h3>
        <div id="sheet-content"></div>
    </section>

    <button id="export-pdf" class="hidden" onclick="exportToPDF()">Download PDF - Wanted Poster Style</button>

    <script>
        const { jsPDF } = window.jspdf;

        // Data objects (unchanged, but consolidated)
        const ARCHETYPES = {
            "Adventurer": { core: ["DEX", "APP"], occupations: ["Archaeologist", "Big Game Hunter", "Bounty Hunter", "Confidence Trickster", "Dilettante", "Entertainer", "Expressman/woman", "Gambler", "Gentleman/lady", "Gunfighter", "Hobo", "Journalist", "Outlaw", "Scout/Mountain Person", "Soldier/Warrior"], bonusSkills: ["Climb", "Drive Coach/Wagon", "First Aid", "Fighting (any)", "Firearms (any)", "Gambling", "Jump", "Language Other (any)", "Mechanical Repair", "Ride", "Stealth", "Survival", "Rope Use", "Swim"], talent: 'Always Onward!' },
            "Beefcake": { core: ["STR"], occupations: ["Bounty Hunter", "Cowboy/girl", "Entertainer", "Farmer", "Gunfighter", "Hired Muscle", "Lawman", "Outlaw", "Person of God", "Pugilist", "Sailor", "Scout/Mountain Person", "Soldier/warrior", "Tribe Member"], bonusSkills: ["Climb", "Fighting (Brawl)", "Intimidate", "Listen", "Mechanical Repair", "Psychology", "Swim", "Throw"], talent: 'Hard Hitter' },
            "Bon Vivant": { core: ["SIZ"], occupations: ["Artist", "Author", "Big Game Hunter", "Butler", "Confidence Trickster", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Hobo", "Hooker", "Itinerant Worker", "Librarian", "Merchant", "Politician", "Rancher"], bonusSkills: ["Appraise", "Art/Craft (any)", "Charm", "Fast Talk", "Language Other (any)", "Listen", "Spot Hidden", "Psychology", "Gambling"], talent: 'Living Life!' },
            "Cold Blooded": { core: ["INT"], occupations: ["Bounty Hunter", "Confidence Trickster", "Doctor", "Gambler", "Gunfighter", "Hired Muscle", "Hooker", "Journalist", "Lawman", "Lawyer/Judge", "Merchant", "Outlaw", "Politician", "Pugilist", "Scientist/Engineer", "Soldier", "Spy", "Zealot"], bonusSkills: ["Art/Craft (Acting)", "Disguise", "Fighting (any)", "Firearms (any)", "First Aid", "Gambling", "History", "Intimidate", "Law", "Listen", "Mechanical Repair", "Psychology", "Stealth", "Survival", "Track", "Trap"], talent: 'All According to Plan' },
            "Egghead": { core: ["INT", "EDU"], occupations: ["Author", "Craftsperson", "Doctor", "Gambler", "Itinerant Worker", "Journalist", "Lawyer/Judge", "Librarian", "Minor", "Student/Teacher", "Scientist/Engineer"], bonusSkills: ["Anthropology", "Appraise", "Electrical Repair", "First Aid", "Gambling", "Language Other (any)", "Library Use", "Mechanical Repair", "Operate Heavy Machinery", "Science", "Trap"], talent: 'Eureka!' },
            "Explorer": { core: ["DEX", "POW"], occupations: ["Author", "Big Game Hunter", "Coachman/woman", "Dilettante", "Expressman/woman", "Gentleman/lady", "Hobo", "Itinerant Worker", "Person of God", "Merchant", "Miner", "Sailor", "Student/Teacher", "Scout", "Tribe Member"], bonusSkills: ["Animal Handling", "Anthropology", "Archaeology", "Climb", "Drive Coach/Wagon", "Fighting (Brawl)", "First Aid", "Jump", "Language Other (any)", "Natural World", "Navigate", "Ride", "Rope Use", "Stealth", "Survival", "Track"], talent: 'Born Traveler' },
            "Femme Fatale": { core: ["APP", "INT"], occupations: ["Artist", "Bartender", "Bounty Hunter", "Confidence Trickster", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Hooker", "Journalist", "Librarian", "Outlaw", "Politician", "Spy"], bonusSkills: ["Art/Craft (Acting)", "Appraise", "Charm", "Disguise", "Drive Coach/Wagon", "Fast Talk", "Fighting (Brawl)", "Firearms (Handgun)", "Gambling", "Listen", "Psychology", "Read Lips", "Rope Use", "Sleight of Hand", "Stealth", "Trap"], talent: 'Irresistible' },
            "Hard Boiled": { core: ["CON"], occupations: ["Bounty Hunter", "Coachman/woman", "Cowboy/girl", "Farmer", "Gunfighter", "Hired Muscle", "Lawman", "Outlaw", "Person of God", "Pugilist", "Sailor", "Scout", "Soldier", "Zealot"], bonusSkills: ["Fighting (Brawl)", "Firearms (any)", "Drive Coach/Wagon", "Fast Talk", "Intimidate", "Law", "Listen", "Locksmith", "Sleight of Hand", "Spot Hidden", "Rope Use", "Stealth", "Throw"], talent: 'That all you got?' },
            "Hunter": { core: ["INT", "CON"], occupations: ["Big Game Hunter", "Bounty Hunter", "Cowboy/girl", "Dilettante", "Expressman/woman", "Lawman", "Miner", "Outlaw", "Scout", "Tribe Member", "Zealot"], bonusSkills: ["Animal Handling", "Fighting (any)", "Firearms (any)", "First Aid", "Listen", "Natural World", "Navigate", "Spot Hidden", "Ride", "Rope Use", "Stealth", "Survival", "Swim", "Track", "Trap"], talent: 'No Escape' },
            "Mystic": { core: ["POW"], occupations: ["Artist", "Confidence Trickster", "Craftsperson", "Doctor", "Entertainer", "Gentleman/lady", "Hobo", "Person of God", "Student/Teacher", "Scientist/Engineer", "Tribe Member", "Zealot"], bonusSkills: ["Art/Craft (any)", "Disguise", "History", "Language Other (any)", "Listen", "Natural World", "Occult", "Psychology", "Science", "Sleight of Hand", "Spot Hidden", "Stealth", "Track"], talent: 'Powers' },
            "Outsider": { core: ["INT", "CON"], occupations: ["Artist", "Craftsperson", "Dilettante", "Entertainer", "Farmer", "Expressman/woman", "Hobo", "Itinerant Worker", "Miner", "Person of God", "Sailor", "Scout", "Tribe Member", "Zealot"], bonusSkills: ["Art/Craft (any)", "Animal Handling", "Fighting (any)", "First Aid", "Intimidate", "Language Other (any)", "Listen", "Medicine", "Navigate", "Stealth", "Survival (any)", "Track"], talent: 'Unorthodox Methods' },
            "Rogue": { core: ["DEX", "APP"], occupations: ["Artist", "Bartender", "Confidence Trickster", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Gunfighter", "Hobo", "Hooker", "Lawyer", "Outlaw", "Pugilist", "Spy"], bonusSkills: ["Appraise", "Art/Craft (any)", "Charm", "Disguise", "Fast Talk", "Gambling", "Law", "Locksmith", "Psychology", "Read Lips", "Rope Use", "Sleight of Hand", "Spot Hidden", "Stealth", "Trap"], talent: 'Scoundrel to The Bone' },
            "Scholar": { core: ["EDU"], occupations: ["Author", "Butler", "Dilettante", "Doctor", "Gentleman/lady", "Journalist", "Lawyer/Judge", "Librarian", "Merchant", "Politician", "Student/Teacher", "Scientist/Engineer"], bonusSkills: ["Accounting", "Appraise", "Anthropology", "Archaeology", "History", "Language Other (any)", "Law", "Library Use", "Medicine", "Natural World", "Occult", "Psychology", "Science"], talent: 'Um, Actually' },
            "Steadfast": { core: ["CON"], occupations: ["Butler", "Cowboy/girl", "Craftsperson", "Doctor", "Expressman/woman", "Farmer", "Gentleman/lady", "Gunfighter", "Hired Muscle", "Lawman", "Person of God", "Politician", "Pugilist", "Soldier", "Tribe Member"], bonusSkills: ["Accounting", "Drive Coach/Wagon", "Fighting (any)", "Firearms (Handgun)", "First Aid", "History", "Intimidate", "Law", "Natural World", "Navigate", "Persuade", "Psychology", "Ride", "Spot Hidden", "Survival"], talent: 'Bulwark of Justice' },
            "Swashbuckler": { core: ["DEX", "APP"], occupations: ["Artist", "Big Game Hunter", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Gunfighter", "Journalist", "Lawman", "Outlaw", "Sailor"], bonusSkills: ["Art/Craft (any)", "Charm", "Climb", "Dodge", "Fighting (any)", "Jump", "Language Other (any)", "Mechanical Repair", "Navigate", "Rope Use", "Stealth", "Swim", "Throw"], talent: 'Dazzling Heroics' },
            "Thrill Seeker": { core: ["DEX", "POW"], occupations: ["Big Game Hunter", "Bounty Hunter", "Confidence Trickster", "Dilettante", "Entertainer", "Expressman/woman", "Gambler", "Gunfighter", "Hired Muscle", "Hooker", "Outlaw", "Pugilist", "Sailor", "Soldier", "Spy", "Zealot"], bonusSkills: ["Art/Craft (any)", "Charm", "Climb", "Drive Coach/Wagon", "Fast Talk", "Gambling", "Jump", "Mechanical Repair", "Navigate", "Ride", "Stealth", "Survival", "Swim", "Throw"], talent: 'Adrenaline Junkie' },
            "Two-Fisted": { core: ["STR", "SIZ"], occupations: ["Big Game Hunter", "Bounty Hunter", "Coachman/woman", "Cowboy/girl", "Gunfighter", "Hired Muscle", "Outlaw", "Pugilist", "Scout", "Soldier", "Zealot", "Tribe Member"], bonusSkills: ["Dodge", "Drive Coach/Wagon", "Fighting (Brawl)", "Firearms (any)", "Intimidate", "Listen", "Mechanical Repair", "Spot Hidden", "Swim", "Throw"], talent: 'Get Some!' }
        };

        const OCCUPATIONS = {
            'Archaeologist': { skillPointsFormula: (edu, dex, pow) => edu * 2 + Math.max(dex * 2, pow * 2), crRange: [6, 60], skills: ['Archaeology', 'History', 'Library Use', 'Spot Hidden', 'Navigate', 'Language Other (any)', 'Anthropology', 'any one other'] },
            'Artist': { skillPointsFormula: (edu, dex, pow) => edu * 2 + Math.max(dex * 2, pow * 2), crRange: [6, 60], skills: ['Art/Craft (any)', 'History', 'Library Use', 'Psychology', 'Spot Hidden', 'Sleight of Hand', 'any two other'] },
            'Author': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 30], skills: ['Art (Literature)', 'History', 'Library Use', 'Natural World or Occult', 'Other Language', 'Own Language', 'Psychology', 'any one other'] },
            'Bartender': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [8, 25], skills: ['Accounting', 'two interpersonal (Charm, Fast Talk, Intimidate, or Persuade)', 'Fighting (Brawl)', 'Listen', 'Psychology', 'Spot Hidden', 'any one other'] },
            'Big Game Hunter': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [20, 50], skills: ['Firearms', 'Listen or Spot Hidden', 'Natural World', 'Navigate', 'Other Language or Survival (any)', 'Stealth', 'Track', 'Trap'] },
            'Bounty Hunter': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [9, 30], skills: ['Drive Coach/Wagon', 'Fighting or Firearms (any)', 'one interpersonal (Fast Talk, Charm, Intimidate, or Persuade)', 'Law', 'Psychology', 'Rope Use', 'Track', 'Trap', 'Stealth'] },
            'Butler': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 40], skills: ['Accounting or Appraise', 'Art/Craft (any, e.g. Cook, Tailor, Barber)', 'First Aid', 'Listen', 'Other Language', 'Psychology', 'Spot Hidden', 'any two other'] },
            'Coachman/woman': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [10, 40], skills: ['Drive Coach/Wagon', 'two interpersonal (Charm, Fast Talk, Intimidate, or Persuade)', 'Fighting or Firearms (any)', 'Listen', 'Ride', 'Spot Hidden', 'Throw'] },
            'Confidence Trickster': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [20, 60], skills: ['Appraise', 'Art/Craft (Acting)', 'Charm', 'Disguise', 'Fast Talk', 'Gambling', 'Psychology', 'Sleight of Hand', 'Spot Hidden', 'Trap'] },
            'Cowboy/girl': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [9, 25], skills: ['Animal Handling', 'Drive Coach/Wagon or Ride', 'Firearms (Rifle/Shotgun or Handgun)', 'First Aid', 'Listen', 'Natural World', 'Rope Use', 'Survival', 'Track'] },
            'Craftsperson': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 40], skills: ['Art/Craft (any)', 'two other relevant to craft', 'Appraise', 'Electrical Repair', 'Listen', 'Mechanical Repair', 'Spot Hidden', 'any one other'] },
            'Dilettante': { skillPointsFormula: (edu) => edu * 4, crRange: [50, 99], skills: ['Accounting', 'Appraise', 'Art/Craft (any)', 'Firearms', 'Language Other (any)', 'Ride', 'any one other'] },
            'Doctor': { skillPointsFormula: (edu) => edu * 4, crRange: [40, 99], skills: ['First Aid', 'Medicine', 'Psychology', 'Science (Biology, Chemistry, Pharmacy, etc.)', 'any two others'] },
            'Entertainer': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [9, 40], skills: ['Art/Craft (any)', 'Charm', 'Disguise', 'Fast Talk', 'Sleight of Hand', 'any three others'] },
            'Expressman/woman': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [9, 25], skills: ['Animal Handling', 'Drive Coach/Wagon', 'Firearms (any)', 'Listen', 'Navigate', 'Ride', 'Spot Hidden', 'Survival'] },
            'Farmer': { skillPointsFormula: (edu) => edu * 2, crRange: [9, 30], skills: ['Animal Handling', 'Art/Craft (Farming)', 'First Aid', 'Natural World', 'Ride', 'Survival', 'Throw', 'any one other'] },
            'Gambler': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [20, 50], skills: ['Appraise', 'Fast Talk', 'Gambling', 'Listen', 'Sleight of Hand', 'Spot Hidden', 'any two others'] },
            'Gentleman/lady': { skillPointsFormula: (edu) => edu * 4, crRange: [50, 99], skills: ['Accounting', 'Appraise', 'Art/Craft (any)', 'Drive Coach/Wagon', 'Law', 'Other Language', 'Ride', 'any one other'] },
            'Gunfighter': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [10, 40], skills: ['Drive Coach/Wagon or Ride', 'Fast Talk or Intimidate', 'Firearms (any)', 'Fighting (Brawl)', 'Listen', 'Psychology', 'Spot Hidden', 'Stealth'] },
            'Hired Muscle': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [10, 25], skills: ['Fighting (Brawl)', 'Firearms (any)', 'Intimidate', 'Listen', 'Psychology', 'Stealth', 'Survival', 'Throw'] },
            'Hobo': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [0, 9], skills: ['Listen', 'Navigate', 'Natural World', 'Stealth', 'Survival', 'Track', 'any one other'] },
            'Hooker': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [9, 25], skills: ['Charm', 'Disguise', 'Fast Talk', 'Psychology', 'Sleight of Hand', 'any two others'] },
            'Itinerant Worker': { skillPointsFormula: (edu, str) => edu * 2 + str * 2, crRange: [9, 25], skills: ['Art/Craft (any)', 'Climb', 'Electrical Repair or Mechanical Repair', 'First Aid', 'Listen', 'Spot Hidden', 'Throw'] },
            'Journalist': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 50], skills: ['Art/Craft (Photography or Typing)', 'Fast Talk', 'History', 'Library Use', 'Listen', 'Own Language', 'Persuade', 'Psychology'] },
            'Lawman': { skillPointsFormula: (edu, con) => edu * 2 + con * 2, crRange: [10, 40], skills: ['Firearms (Handgun)', 'Fighting (Brawl)', 'Intimidate', 'Law', 'Listen', 'Persuade', 'Psychology', 'Spot Hidden', 'Ride'] },
            'Lawyer/Judge': { skillPointsFormula: (edu) => edu * 4, crRange: [20, 80], skills: ['Fast Talk', 'Law', 'Library Use', 'Own Language', 'Persuade', 'Psychology', 'any one other'] },
            'Librarian': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 40], skills: ['Accounting', 'Anthropology or Archaeology', 'History', 'Library Use', 'Occult', 'Own Language', 'any one other'] },
            'Merchant': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [20, 70], skills: ['Accounting', 'Appraise', 'Fast Talk', 'Listen', 'Persuade', 'Psychology', 'Spot Hidden', 'any one other'] },
            'Miner': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [9, 25], skills: ['Climb', 'Electrical Repair or Mechanical Repair', 'Jump', 'Listen', 'Navigate', 'Ride', 'Spot Hidden', 'Survival'] },
            'Outlaw': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [0, 9], skills: ['Drive Coach/Wagon or Ride', 'Firearms (any)', 'Fighting (any)', 'Fast Talk or Intimidate', 'Mechanical Repair', 'Stealth', 'Survival'] },
            'Person of God': { skillPointsFormula: (edu, pow) => edu * 2 + pow * 2, crRange: [9, 40], skills: ['History', 'Library Use', 'Listen', 'Medicine', 'Persuade', 'Psychology', 'any two others'] },
            'Politician': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [30, 80], skills: ['Fast Talk', 'Law', 'Persuade', 'Psychology', 'History', 'Own Language', 'any two others'] },
            'Pugilist': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [9, 25], skills: ['Dodge', 'Fighting (Brawl)', 'First Aid', 'Intimidate', 'Listen', 'Psychology', 'any two others'] },
            'Rancher': { skillPointsFormula: (edu, str) => edu * 2 + str * 2, crRange: [10, 40], skills: ['Animal Handling', 'Appraise', 'Art/Craft (any)', 'Drive Coach/Wagon', 'Listen', 'Natural World', 'Ride', 'Rope Use', 'Survival', 'Track'] },
            'Sailor': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [9, 25], skills: ['Climb', 'Fighting (Brawl)', 'Listen', 'Navigate', 'Jump', 'Mechanical Repair', 'Rope Use', 'Swim', 'Throw'] },
            'Scout/Mountain Person': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [9, 30], skills: ['Climb', 'Listen', 'Natural World', 'Navigate', 'Ride', 'Spot Hidden', 'Stealth', 'Survival', 'Track'] },
            'Scientist/Engineer': { skillPointsFormula: (edu) => edu * 4, crRange: [20, 80], skills: ['Electrical Repair', 'Library Use', 'Mechanical Repair', 'Science (any)', 'any four others'] },
            'Soldier/Warrior': { skillPointsFormula: (edu, dex, str, con) => edu * 2 + Math.max(dex * 2, str * 2, con * 2), crRange: [9, 30], skills: ['Dodge', 'Fighting (any)', 'Firearms (any)', 'Intimidate', 'Listen', 'Stealth', 'Survival', 'any one other'] },
            'Spy': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [9, 50], skills: ['Disguise', 'Fast Talk', 'Listen', 'Persuade', 'Psychology', 'Read Lips', 'Sleight of Hand', 'Stealth'] },
            'Student/Teacher': { skillPointsFormula: (edu, int) => edu * 2 + int * 2, crRange: [9, 25], skills: ['Appraise', 'History', 'Language Other', 'Library Use', 'Occult', 'Own Language', 'Persuade', 'Psychology', 'Science'] },
            'Tribe Member': { skillPointsFormula: (edu, pow) => edu * 2 + pow * 2, crRange: [9, 25], skills: ['Listen', 'Natural World', 'Navigate', 'Occult', 'Stealth', 'Survival', 'Swim', 'Track'] },
            'Zealot': { skillPointsFormula: (edu, pow, con) => edu * 2 + Math.max(pow * 2, con * 2), crRange: [9, 25], skills: ['History', 'Intimidate', 'Listen', 'Persuade', 'Psychology', 'any two others'] },
            'Lawyer': { skillPointsFormula: (edu) => edu * 4, crRange: [20, 80], skills: ['Fast Talk', 'Law', 'Library Use', 'Own Language', 'Persuade', 'Psychology', 'any one other'] } // Added missing Lawyer
        };

        const HINDRANCES = {
            'Blind (7)': {value: 7, desc: 'You can’t see shit! You suffer -80% to any skill that requires sight (Most skills, but Keeper’s discretion). You increase the difficulty level of Spot Hidden rolls by 2.' },
            // ... (all other hindrances as provided)
            'Tongue-Tied (1)': {value: 1, desc: 'You always flub your one-liners and insults, better let your gun do the barking. You suffer -10% to Charm, Fast Talk, Intimidate, Persuade and Languages.' }
        };

        const TALENTS = {
            'True Grit (7)': {value: 7, desc: 'Backing down just ain’t in your blood partner! At the beginning of each session, your recover POW in the same way you do Luck. You have advantage to all POW rolls.' },
            // ... (all other talents as provided)
            'Ruthless (1)': {value: 1, desc: 'You done worse than most and aren’t easily impressed. You do not lose sanity for killing, torturing or seeing gruesome sights.' }
        };

        const ALL_SKILLS = {
            'Accounting': { base: 5 }, 'Animal Handling': { base: 5 }, 'Anthropology': { base: 1 }, 'Appraise': { base: 5 },
            'Archaeology': { base: 1 }, 'Art/Craft (any)': { base: 5 }, 'Charm': { base: 15 }, 'Climb': { base: 20 },
            'Credit Rating': { base: 0 }, 'Demolitions': { base: 1 }, 'Disguise': { base: 5 }, 'Dodge': { base: 0 },
            'Drive Coach/Wagon': { base: 20 }, 'Electrical Repair': { base: 0 }, 'Fast Talk': { base: 5 },
            'Fighting (any)': { base: 25 }, 'Firearms (any)': { base: 20 }, 'First Aid': { base: 30 }, 'Gambling': { base: 10 },
            'History': { base: 5 }, 'Intimidate': { base: 15 }, 'Jump': { base: 20 }, 'Language Own': { base: 0 },
            'Language Other': { base: 0 }, 'Law': { base: 5 }, 'Library Use': { base: 20 }, 'Listen': { base: 20 },
            'Locksmith': { base: 1 }, 'Mechanical Repair': { base: 10 }, 'Medicine': { base: 1 }, 'Natural World': { base: 20 },
            'Navigate': { base: 10 }, 'Occult': { base: 5 }, 'Operate Heavy Machinery': { base: 1 }, 'Persuade': { base: 10 },
            'Psychology': { base: 10 }, 'Read Lips': { base: 1 }, 'Ride': { base: 20 }, 'Rope Use': { base: 5 },
            'Science (any)': { base: 1 }, 'Sleight of Hand': { base: 10 }, 'Spot Hidden': { base: 25 }, 'Stealth': { base: 20 },
            'Survival': { base: 10 }, 'Swim': { base: 20 }, 'Throw': { base: 20 }, 'Track': { base: 10 },
            'Trap': { base: 10 },
            'Medium': { base: 1 }, 'Telekinesis': { base: 1 }, 'Shamanic Magic': { base: 1 }, 'Witchcraft': { base: 1 }
        };

        const charList = ['STR', 'CON', 'DEX', 'POW', 'APP', 'EDU', 'INT', 'SIZ'];

        let character = {
            archetype: null,
            occupation: null,
            characteristics: {},
            skills: {},
            talents: [],
            hindrances: [],
            age: null,
            luck: 0,
            heritageText: ''
        };

        let coreCharacteristic = null;
        let coreRollValue = 0;
        const totalCharPoints = 460;

        // Initialize
        function init() {
            populateSelect('archetype-select', Object.keys(ARCHETYPES));
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">Select...</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        function nextStep(step) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
            if (step === 6) calculateAndDisplaySkillPoints();
            if (step === 7) {
                populateHindSelect();
                populateTalSelect();
                document.getElementById('arch-talent').textContent = character.archetype.talent;
            }
        }

        function prevStep(toStep) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${toStep}`).classList.remove('hidden');
        }

        function selectArchetype() {
            const value = document.getElementById('archetype-select').value;
            if (!value) return alert("Please select an Archetype.");
            character.archetype = ARCHETYPES[value];
            populateSelect('occupation-select', character.archetype.occupations);
            updateCoreCharSelect();
            nextStep(2);
        }

        function selectOccupation() {
            const value = document.getElementById('occupation-select').value;
            if (!value) return alert("Please select an Occupation.");
            character.occupation = OCCUPATIONS[value];
            nextStep(3);
        }

        function updateCoreCharSelect() {
            populateSelect('core-char-select', character.archetype.core);
            updateCharacteristicInputs();
        }

        function rollCore() {
            const value = document.getElementById('core-char-select').value;
            if (!value) return alert("Please select a core characteristic first.");
            updateCharacteristicInputs();
            coreCharacteristic = value;
            const d6 = Math.floor(Math.random() * 6) + 1;
            coreRollValue = 65 + d6 * 5;
            document.getElementById('core-roll-display').textContent = coreRollValue;
            const input = document.getElementById(value);
            input.value = coreRollValue;
            input.min = coreRollValue;
            updateRemainingPoints();
        }

        function updateCharacteristicInputs() {
            const div = document.getElementById('char-alloc');
            div.innerHTML = '';
            charList.forEach(char => {
                const group = document.createElement('div');
                group.className = 'char-input-group';
                group.innerHTML = `<label for="${char}">${char}:</label><input type="number" id="${char}" value="15" min="15" max="130" oninput="updateRemainingPoints()">`;
                div.appendChild(group);
            });
            document.getElementById('core-roll-display').textContent = 'Not rolled yet';
            coreCharacteristic = null;
            coreRollValue = 0;
            updateRemainingPoints();
        }

        function updateRemainingPoints() {
            let spent = 0;
            document.querySelectorAll('#char-alloc input[type="number"]').forEach(i => spent += +i.value || 0);
            document.getElementById('remaining-points').textContent = totalCharPoints + coreRollValue - spent;
        }

        function completeChars() {
            if (!coreCharacteristic || !coreRollValue) return alert("Please roll for a core characteristic first.");
            const inputs = [...document.querySelectorAll('#char-alloc input[type="number"]')];
            let spent = 0, errors = [];
            inputs.forEach(input => {
                const val = +input.value;
                if (isNaN(val) || val < +input.min || val > 130) errors.push(`${input.id} must be ${input.min}-130.`);
                spent += val;
            });
            if (spent !== totalCharPoints + coreRollValue) errors.push(`Total must be ${totalCharPoints + coreRollValue}.`);
            if (errors.length) return alert(errors.join('\n'));
            inputs.forEach(input => character.characteristics[input.id] = +input.value);
            nextStep(4);
        }

        function toggleDeduct() {
            const value = document.getElementById('age-select').value;
            ['age-deduct', 'age-18-21-deduct'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (value === '18-21') document.getElementById('age-18-21-deduct').classList.remove('hidden');
            else if (['40-49', '50-59', '60-69'].includes(value)) {
                document.getElementById('age-deduct').classList.remove('hidden');
                const deduct = {'40-49':10,'50-59':15,'60-69':20}[value];
                document.getElementById('required-deduct').textContent = deduct;
            }
        }

        function validateAgeDeduct() {
            const value = document.getElementById('age-select').value;
            let total = 0, deductStr = 0, deductCon = 0, deductDex = 0;
            if (value === '18-21') {
                deductStr = +document.getElementById('deduct-str-18-21').value || 0;
                deductCon = +document.getElementById('deduct-con-18-21').value || 0;
                deductDex = +document.getElementById('deduct-dex-18-21').value || 0;
                total = deductStr + deductCon + deductDex;
                document.getElementById('total-deduct-18-21').textContent = total;
            } else {
                deductStr = +document.getElementById('deduct-str').value || 0;
                deductCon = +document.getElementById('deduct-con').value || 0;
                deductDex = +document.getElementById('deduct-dex').value || 0;
                total = deductStr + deductCon + deductDex;
                document.getElementById('total-deduct').textContent = total;
            }
        }

        function applyAge() {
            const value = document.getElementById('age-select').value;
            character.age = value;
            const deductMap = {'18-21':5, '40-49':10, '50-59':15, '60-69':20};
            let deduct = deductMap[value] || 0;
            let strD = 0, conD = 0, dexD = 0;
            if (deduct) {
                const prefix = value === '18-21' ? '-18-21' : '';
                strD = +document.getElementById(`deduct-str${prefix}`).value || 0;
                conD = +document.getElementById(`deduct-con${prefix}`).value || 0;
                dexD = +document.getElementById(`deduct-dex${prefix}`).value || 0;
                if (strD + conD + dexD !== deduct) return alert(`Distribute exactly ${deduct} points.`);
            }
            character.characteristics.STR -= strD;
            character.characteristics.CON -= conD;
            character.characteristics.DEX -= dexD;
            const eduMods = {'22-39':10, '40-49':20, '50-59':30, '60-69':40};
            const appMods = {'40-49':-10, '50-59':-15, '60-69':-20};
            character.characteristics.EDU += eduMods[value] || 0;
            character.characteristics.APP += appMods[value] || 0;
            nextStep(5);
        }

        function rollLuck() {
            const d6a = Math.floor(Math.random() * 6) + 1;
            const d6b = Math.floor(Math.random() * 6) + 1;
            character.luck = 30 + (d6a + d6b) * 5;
            if (character.age === '18-21' && character.luck > 90) character.luck = 90;
            document.getElementById('luck-display').textContent = character.luck + (character.age === '18-21' && character.luck === 90 ? ' (Capped)' : '');
        }

        function calcSecondaries() {
            if (!character.luck) return alert('Roll Luck first.');
            let move = 7;
            const {DEX, STR, SIZ} = character.characteristics;
            if (DEX > STR && DEX > SIZ) move = 8;
            else if (Math.max(STR, SIZ) > DEX) move = 6;
            if (DEX > 90) move += 1;
            if (STR > 90) move -= 1;
            const ageMods = {'50-59':-1, '60-69':-2};
            move += ageMods[character.age] || 0;
            character.characteristics.Move = move;
            character.characteristics.HP = Math.ceil((character.characteristics.CON + SIZ) / 10);
            character.characteristics.Sanity = character.characteristics.POW;
            character.characteristics.MP = Math.floor(character.characteristics.POW / 5);
            const build = STR + SIZ;
            character.characteristics.Build = build < 65 ? -2 : build < 85 ? -1 : build < 125 ? 0 : build < 165 ? 1 : build < 205 ? 2 : 3;
            character.characteristics.Dodge = Math.floor(DEX / 2);
            document.getElementById('secondary-display').innerHTML = `
                <p><strong>Move:</strong> ${move}</p>
                <p><strong>Hit Points:</strong> ${character.characteristics.HP}</p>
                <p><strong>Magic Points:</strong> ${character.characteristics.MP}</p>
                <p><strong>Sanity:</strong> ${character.characteristics.Sanity}</p>
                <p><strong>Build:</strong> ${character.characteristics.Build}</p>
                <p><strong>Dodge:</strong> ${character.characteristics.Dodge}</p>
            `;
            nextStep(6);
        }

        function getSkillPoints() {
            const {skillPointsFormula, skills} = character.occupation;
            // Adjust args based on formula arity (simplified; assume max 8)
            const args = [character.characteristics.EDU, character.characteristics.DEX, character.characteristics.POW, character.characteristics.STR, character.characteristics.CON, character.characteristics.APP, character.characteristics.INT, character.characteristics.SIZ];
            const occPoints = skillPointsFormula(...args.slice(0, skillPointsFormula.length));
            return { occPoints, persPoints: character.characteristics.INT * 2, archPoints: 100 };
        }

        function isOccupationSkill(skill) {
            const occSkills = character.occupation.skills;
            if (occSkills.includes(skill)) return true;
            if (occSkills.some(s => s.includes('interpersonal') && ['Charm', 'Fast Talk', 'Intimidate', 'Persuade'].some(inter => skill.includes(inter)))) return true;
            if ((occSkills.includes('Fighting or Firearms (any)') || occSkills.includes('Fighting (any)')) && skill.includes('Fighting')) return true;
            if ((occSkills.includes('Fighting or Firearms (any)') || occSkills.includes('Firearms (any)')) && skill.includes('Firearms')) return true;
            if (occSkills.includes('Art/Craft (any)') && skill.includes('Art/Craft')) return true;
            if (occSkills.includes('Language Other (any)') && skill.includes('Language Other')) return true;
            return occSkills.some(s => s.includes('any') && !s.includes('interpersonal'));
        }

        function isArchetypeSkill(skill) {
            const skills = character.archetype.bonusSkills;
            if (skills.includes(skill)) return true;
            if (skills.includes('Fighting (any)') && skill.includes('Fighting')) return true;
            if (skills.includes('Firearms (any)') && skill.includes('Firearms')) return true;
            if (skills.includes('Art/Craft (any)') && skill.includes('Art/Craft')) return true;
            if (skills.includes('Language Other (any)') && skill.includes('Language Other')) return true;
            return false;
        }

        function calculateAndDisplaySkillPoints() {
            const {occPoints, persPoints, archPoints} = getSkillPoints();
            ['occ-total', 'pers-total', 'arch-total'].forEach(id => document.getElementById(id).textContent = eval(id.replace('-total', 'Points')));
            const div = document.getElementById('skill-alloc');
            div.innerHTML = '';
            Object.keys(ALL_SKILLS).sort().forEach(skill => {
                const base = ALL_SKILLS[skill].base;
                const isOcc = isOccupationSkill(skill);
                const isArch = isArchetypeSkill(skill);
                const item = document.createElement('div');
                item.className = `skill-item ${isOcc ? 'occupation-skill' : ''} ${isArch ? 'archetype-skill' : ''}`;
                item.innerHTML = `
                    <div class="skill-item-title">${skill}</div>
                    <div class="skill-input-container">
                        <span>Base: ${base}%</span>
                        <input type="number" class="skill-input" value="${base}" min="${base}">
                    </div>
                    ${isOcc ? '<span class="skill-label">Occupational</span>' : ''}
                    ${isArch ? '<span class="skill-label">Archetype Bonus</span>' : ''}
                `;
                div.appendChild(item);
            });
            document.getElementById('complete-skills-btn').disabled = false;
        }

        function completeSkills() {
            character.skills = {};
            document.querySelectorAll('.skill-input').forEach((input, index) => {
                const title = document.querySelectorAll('.skill-item-title')[index].textContent.trim();
                character.skills[title] = +input.value || 0;
            });
            nextStep(7);
        }

        function populateHindSelect() {
            const div = document.getElementById('hindrance-checkboxes');
            div.innerHTML = Object.entries(HINDRANCES).map(([key, data]) => `
                <label class="hindrance-item">
                    <input type="checkbox" value="${key}">
                    <div class="hindrance-name" onclick="toggleDescription(this)">${key}</div>
                    <div class="hindrance-description hidden">${data.desc}</div>
                </label>
            `).join('');
            div.querySelectorAll('input').forEach(input => input.onchange = updateSelectedHindrances);
        }

        function populateTalSelect() {
            const div = document.getElementById('talent-checkboxes');
            div.innerHTML = Object.entries(TALENTS).map(([key, data]) => `
                <label class="talent-item">
                    <input type="checkbox" value="${key}">
                    <div class="talent-name" onclick="toggleDescription(this)">${key}</div>
                    <div class="talent-description hidden">${data.desc}</div>
                </label>
            `).join('');
            div.querySelectorAll('input').forEach(input => input.onchange = updateSelectedTalents);
        }

        function toggleDescription(el) {
            el.nextElementSibling.classList.toggle('hidden');
        }

        function updateSelectedHindrances() {
            const checked = [...document.querySelectorAll('#hindrance-checkboxes input:checked')];
            character.hindrances = checked.map(cb => ({name: cb.value, value: HINDRANCES[cb.value].value}));
            document.getElementById('selected-hinds').textContent = character.hindrances.map(h => h.name.split(' (')[0]).join(', ') || 'None';
            document.getElementById('talent-points').textContent = character.hindrances.reduce((sum, h) => sum + h.value, 0);
        }

        function updateSelectedTalents() {
            const checked = [...document.querySelectorAll('#talent-checkboxes input:checked')];
            character.talents = checked.map(cb => ({name: cb.value, value: TALENTS[cb.value].value}));
            document.getElementById('selected-tals').textContent = character.talents.map(t => t.name.split(' (')[0]).join(', ') || 'None';
        }

        function rollNaturalTalent() {
            const lowTalents = Object.entries(TALENTS).filter(([,data]) => data.value >= 1 && data.value <= 3);
            if (lowTalents.length) {
                const [name, data] = lowTalents[Math.floor(Math.random() * lowTalents.length)];
                document.getElementById('natural-talent').textContent = `${name} (Value: ${data.value})`;
            } else {
                document.getElementById('natural-talent').textContent = 'No natural talent rolled';
            }
        }

        function completeHT() {
            nextStep(8);
        }

        function completeBackstory() {
            ['name', 'gender', 'description', 'ideology', 'significant-people', 'meaningful', 'traits', 'hair-eye', 'marks'].forEach(key => {
                const id = key.replace(/-/g, '');
                character[key.replace(/-/g, '')] = document.getElementById(id).value;
            });
            character.madness = document.getElementById('madness').value;
            character.heritageText = document.getElementById('heritage').selectedOptions[0].text;
            nextStep(9);
        }

        function generateSheet() {
            const title = document.getElementById('sheet-title');
            const content = document.getElementById('sheet-content');
            title.textContent = character.name || 'Untitled Character';

            let skillsHtml = `<h3>Skills</h3><ul>
                <li><strong>Occupation Points:</strong> ${document.getElementById('occ-total').textContent}</li>
                <li><strong>Personal Points:</strong> ${document.getElementById('pers-total').textContent}</li>
                <li><strong>Archetype Bonus:</strong> ${document.getElementById('arch-total').textContent}</li>
            </ul><hr><h3>Skills</h3><ul>`;
            Object.entries(character.skills).sort(([a], [b]) => a.localeCompare(b)).forEach(([skill, val]) => skillsHtml += `<li><strong>${skill}:</strong> ${val}%</li>`);
            skillsHtml += '</ul>';

            content.innerHTML = `
                <h3>Characteristics</h3>
                <ul>${charList.map(c => `<li><strong>${c}:</strong> ${character.characteristics[c] || 15}</li>`).join('')}</ul>
                <h3>Secondary Attributes</h3>
                <p><strong>Luck:</strong> ${character.luck}</p>
                ${skillsHtml}
                <h3>Talents & Hindrances</h3>
                <p><strong>Archetype Talent:</strong> ${character.archetype.talent}</p>
                <p><strong>Natural Talent:</strong> ${document.getElementById('natural-talent').textContent}</p>
                <p><strong>Selected Talents:</strong> ${character.talents.map(t => t.name.split(' (')[0]).join(', ') || 'None'}</p>
                <p><strong>Selected Hindrances:</strong> ${character.hindrances.map(h => h.name.split(' (')[0]).join(', ') || 'None'}</p>
                <h3>Backstory</h3>
                <p><strong>Gender:</strong> ${character.gender}</p>
                <p><strong>Description:</strong> ${character.description}</p>
                <p><strong>Heritage:</strong> ${character.heritageText}</p>
                <p><strong>Ideology/Beliefs:</strong> ${character.ideology}</p>
                <p><strong>Significant People:</strong> ${character.significantPeople}</p>
                <p><strong>Meaningful Location/Possessions:</strong> ${character.meaningful}</p>
                <p><strong>Traits:</strong> ${character.traits}</p>
                <p><strong>Bout of Madness:</strong> ${character.madness}</p>
                <p><strong>Hair/Eye Color:</strong> ${character.hairEye}</p>
                <p><strong>Distinguishing Marks:</strong> ${character.marks}</p>
            `;
            document.getElementById('character-sheet').classList.remove('hidden');
            document.getElementById('export-pdf').classList.remove('hidden');
            document.getElementById('step9').classList.add('hidden');
        }

        function exportToPDF() {
            html2canvas(document.getElementById('character-sheet'), {scale: 2}).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 190;
                const pageHeight = 277;
                let heightLeft = (canvas.height * imgWidth) / canvas.width;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, heightLeft);
                heightLeft -= pageHeight;
                while (heightLeft >= 0) {
                    position = heightLeft - (canvas.height * imgWidth) / canvas.width + pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, heightLeft);
                    heightLeft -= pageHeight;
                }
                pdf.save(`${character.name || 'Character'}-Wanted-Poster.pdf`);
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
