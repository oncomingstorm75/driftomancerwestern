<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Western RPG Charactermancer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Creepster&family=Rye&family=Merriweather:wght@400;700&display=swap');

        :root {
            --primary-bg: linear-gradient(135deg, #2c1a0e 0%, #4c301c 50%, #6e482a 100%);
            --section-bg: rgba(44, 26, 14, 0.7);
            --border-color: #5a3d2e;
            --accent-gold: #c98e2a;
            --text-light: #d8c29e;
            --text-dark: #4c301c;
            --bg-light: #f5f5dc;
            --glow-yellow: #ffeb3b;
            --glow-orange: #ff9800;
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --shadow-gold: rgba(201, 142, 42, 0.5);
            --error-red: #e53e3e;
        }

        body {
            font-family: 'Cinzel', serif;
            background: var(--primary-bg);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="parchment" width="100" height="100" patternUnits="userSpaceOnUse"><rect width="100" height="100" fill="%23f5f5dc"/><path fill="%23d4c3a1" d="M0 0h100v100h-100zM100 0L0 100l100 100V0z"/></pattern></defs><rect width="100" height="100" fill="url(%23parchment)"/></svg>') repeat;
            opacity: 0.1;
            z-index: -1;
        }

        h1 {
            text-align: center;
            color: var(--accent-gold);
            text-shadow: 0 0 5px var(--glow-yellow), 0 0 10px var(--glow-orange);
            font-size: clamp(2em, 5vw, 3em);
            font-family: 'Creepster', cursive;
            margin-bottom: 10px;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            0% { text-shadow: 0 0 5px var(--accent-gold), 0 0 10px var(--accent-gold); }
            100% { text-shadow: 0 0 10px var(--glow-yellow), 0 0 20px var(--glow-orange); }
        }

        .subtitle {
            text-align: center;
            color: #F4A460;
            margin-bottom: 20px;
            font-style: italic;
        }

        section {
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: inset 0 0 15px var(--shadow-dark), 0 0 10px var(--shadow-gold);
            position: relative;
        }

        h2 {
            color: var(--text-light);
            text-align: center;
            text-shadow: 1px 1px 2px #000;
            border-bottom: 2px dashed var(--accent-gold);
            padding-bottom: 10px;
            font-size: 2em;
            margin-top: 0;
        }

        h3 {
            color: var(--text-light);
            border-bottom: 1px dashed var(--accent-gold);
            padding-bottom: 5px;
        }

        select, input, textarea, button {
            background: var(--bg-light);
            border: 1px solid #4c301c;
            border-radius: 5px;
            padding: 8px;
            margin: 5px;
            font-family: inherit;
            color: var(--text-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 5px var(--shadow-gold);
        }
        
        input.specialty-input {
            padding: 4px;
            margin-left: 5px;
            width: 100px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            width: 100%;
        }

        button {
            background: linear-gradient(var(--accent-gold), #a3721e);
            color: var(--text-dark);
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            border: none;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(var(--glow-yellow), var(--accent-gold));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden { display: none; }

        .roll-display {
            color: var(--glow-yellow);
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }

        .char-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .char-input-group label { flex: 1; font-weight: bold; }
        .char-input-group input { flex: 2; }

        .skill-category h3 {
            margin-top: 20px;
            font-family: 'Rye', cursive;
            font-size: 1.5em;
        }
        
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .skill-item {
            border: 1px solid var(--border-color);
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            position: relative;
        }

        .skill-item-title {
            font-weight: bold;
            color: #f5e7c8;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .skill-input-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .skill-labels {
            margin-top: 4px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .skill-label {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 8px;
            font-family: 'Merriweather', sans-serif;
            font-style: normal;
            font-weight: bold;
            color: var(--bg-light);
        }

        .occupation-label {
            background-color: #9d5d5d;
        }

        .archetype-label {
            background-color: #5d9d7b;
        }

        .skill-input {
            width: 50px;
        }

        .talent-grid, .hindrance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 10px;
        }

        .talent-item, .hindrance-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .talent-item:hover, .hindrance-item:hover {
            background: rgba(0,0,0,0.4);
            border-color: var(--accent-gold);
        }

        .talent-header, .hindrance-header {
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }
        
        .talent-header input, .hindrance-header input {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .talent-name, .hindrance-name {
            font-weight: bold;
            color: #f5e7c8;
            transition: color 0.2s;
            pointer-events: none; /* Let the parent div handle clicks */
        }
        
        .talent-description, .hindrance-description {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid var(--accent-gold);
            width: 100%;
            box-sizing: border-box;
        }

        .points-summary {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 15px;
        }

        .points-summary p {
            margin: 0;
            font-weight: bold;
        }
        .points-summary .overspent {
            color: var(--error-red);
            text-shadow: 0 0 3px var(--error-red);
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="number"] {
            width: 60px;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        ul li {
            margin-bottom: 5px;
        }
        
        #archetype-info, #occupation-info {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        #archetype-info h4, #occupation-info h4 {
            color: var(--accent-gold);
            margin-top: 0;
            margin-bottom: 5px;
        }
        
        #archetype-info ul, #occupation-info ul {
            padding-left: 15px;
            list-style-type: disc;
        }
        
        #archetype-info p, #occupation-info p {
            margin-top: 0;
        }


        @media (max-width: 600px) {
            body { padding: 10px; }
            section { padding: 15px; }
            .skill-grid { grid-template-columns: 1fr; }
            .talent-grid, .hindrance-grid { grid-template-columns: 1fr; }
            .char-input-group { flex-direction: column; align-items: flex-start; }
            .points-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <h1>Western RPG Charactermancer</h1>
    <p class="subtitle">Made for Rollingdeadly's The Quick and the Dead</p>

    <section id="step1">
        <h2>Step 1: Choose your Western Archetype</h2>
        <select id="archetype-select" aria-label="Select your character's archetype" onchange="displayArchetypeInfo()">
            <option value="">Select an Archetype...</option>
        </select>
        <div id="archetype-info" class="hidden"></div>
        <button onclick="selectArchetype()">Saddle Up - Next</button>
    </section>

    <section id="step2" class="hidden">
        <h2>Step 2: Choose your Occupation</h2>
        <select id="occupation-select" aria-label="Choose an occupation" onchange="displayOccupationInfo()">
            <option value="">Select an Occupation...</option>
        </select>
        <div id="occupation-info" class="hidden"></div>
        <button onclick="selectOccupation()">Next</button>
        <button onclick="prevStep(1)">Back</button>
    </section>

    <section id="step3" class="hidden">
        <h2>Step 3: Generate Characteristics</h2>
        <p>Core Characteristic: <select id="core-char-select" aria-label="Select core characteristic" onchange="updateCharacteristicInputs()"></select></p>
        <p class="roll-display">Core Roll: <span id="core-roll-display">Not rolled yet</span></p>
        <button onclick="rollCore()">Roll Core</button>
        <p>Total points: 460 + Core. Allocate to: STR, CON, DEX, POW, APP, EDU, INT, SIZ (Min 15, Max 130)</p>
        <div id="char-alloc"></div>
        <p>Remaining Points: <span id="remaining-points">460</span></p>
        <button onclick="completeChars()">Next</button>
        <button onclick="prevStep(2)">Back</button>
    </section>

    <section id="step4" class="hidden">
        <h2>Step 4: Choose Age & Apply Modifiers</h2>
        <select id="age-select" onchange="toggleDeduct()" aria-label="Select age">
            <option value="18-21">18-21: Deduct 5 total among STR, CON, DEX. Max Luck 90.</option>
            <option value="22-39">22-39: +10 EDU</option>
            <option value="40-49">40-49: +20 EDU, -10 APP, -10 total from STR, CON, DEX</option>
            <option value="50-59">50-59: +30 EDU, -15 APP, -15 total from STR, CON, DEX</option>
            <option value="60-69">60-69: +40 EDU, -20 APP, -20 total from STR, CON, DEX</option>
        </select>
        <div id="age-deduct" class="hidden">
            <p>Distribute total deduction across STR, CON, DEX:</p>
            <label>STR: <input id="deduct-str" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <label>CON: <input id="deduct-con" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <label>DEX: <input id="deduct-dex" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <p>Total Deducted: <span id="total-deduct">0</span>/<span id="required-deduct">0</span></p>
        </div>
        <div id="age-18-21-deduct" class="hidden">
            <p>Distribute 5 points to deduct from STR, CON, DEX:</p>
            <label>STR: <input id="deduct-str-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <label>CON: <input id="deduct-con-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <label>DEX: <input id="deduct-dex-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <p>Total Deducted: <span id="total-deduct-18-21">0</span>/5</p>
        </div>
        <button onclick="applyAge()">Apply & Next</button>
        <button onclick="prevStep(3)">Back</button>
    </section>

    <section id="step5" class="hidden">
        <h2>Step 5: Determine Secondary Attributes</h2>
        <button onclick="rollLuck()">Roll Luck</button>
        <p class="roll-display">Luck: <span id="luck-display">Not rolled yet</span></p>
        <button onclick="calcSecondaries()">Calculate All</button>
        <div id="secondary-display"></div>
        <button onclick="nextStep(6)">Next</button>
        <button onclick="prevStep(4)">Back</button>
    </section>

    <section id="step6" class="hidden">
        <h2>Step 6: Skill Points</h2>
        <p>Allocate your skill points. Points are spent from pools in this order: Archetype > Occupation > Personal.</p>
        <div class="points-summary">
            <p>Archetype Points: <span id="arch-rem">100</span> / 100</p>
            <p>Occupation Points: <span id="occ-rem">0</span> / <span id="occ-total">0</span></p>
            <p>Personal Points: <span id="pers-rem">0</span> / <span id="pers-total">0</span></p>
        </div>
        <hr>
        <div id="skill-alloc"></div>
        <button id="complete-skills-btn" onclick="completeSkills()">Next</button>
        <button onclick="prevStep(5)">Back</button>
    </section>

    <section id="step7" class="hidden">
        <h2>Step 7: Determine Hindrances and Talents</h2>
        <button onclick="rollNaturalTalent()">Roll Natural Talent</button>
        <p class="roll-display">Natural Talent: <span id="natural-talent">Not rolled yet</span></p>
        <p><strong>Archetype Talent:</strong> <span id="arch-talent"></span></p>
        <h3>Hindrances (Max 5 total, 1 major >4)</h3>
        <div id="hindrance-checkboxes" class="hindrance-grid"></div>
        <p>Hindrances: <span id="selected-hinds">None</span> | Talent Points: <span id="talent-points">0</span></p>
        <h3>Talents (Max 5 total incl. arch/natural, 1 major >4)</h3>
        <div id="talent-checkboxes" class="talent-grid"></div>
        <p>Talents: <span id="selected-tals">None</span></p>
        <button onclick="completeHT()">Next</button>
        <button onclick="prevStep(6)">Back</button>
    </section>

    <section id="step8" class="hidden">
        <h2>Step 8: Create Backstory</h2>
        <label for="name">Name: <input id="name" type="text"></label>
        <label for="gender">Gender: <input id="gender" type="text"></label>
        <label for="description">Personal Description: <textarea id="description"></textarea></label>
        <label for="heritage">Heritage: 
            <select id="heritage">
                <option value="a">a. African American</option>
                <option value="b">b. Far East (Chinese, Japanese, etc.)</option>
                <option value="c">c. European (Irish American, Italian, German...)</option>
                <option value="d">d. Southern (Mexican, Cuban, etc.)</option>
                <option value="e">e. Mysterious (There’s something odd about you...)</option>
            </select>
        </label>
        <label for="ideology">Ideology/Beliefs: <input id="ideology" type="text"></label>
        <label for="significant-people">Significant People: <input id="significant-people" type="text"></label>
        <label for="meaningful">Meaningful Location/Possessions: <input id="meaningful" type="text"></label>
        <label for="traits">Traits: <input id="traits" type="text"></label>
        <label for="madness">Bout of Madness: <textarea id="madness"></textarea></label>
        <label for="hair-eye">Hair/Eye Color: <input id="hair-eye" type="text"></label>
        <label for="marks">Distinguishing Marks: <input id="marks" type="text"></label>
        <button onclick="completeBackstory()">Next</button>
        <button onclick="prevStep(7)">Back</button>
    </section>

    <section id="step9" class="hidden">
        <h2>Step 9: Finalize Character</h2>
        <button onclick="generateSheet()">Generate Sheet</button>
        <button onclick="prevStep(8)">Back</button>
    </section>

    <section id="character-sheet" class="hidden">
        <h3 id="sheet-title"></h3>
        <div id="sheet-content"></div>
        <button onclick="prevStep(9)">Back to Finalize</button>
    </section>
    
    <script>
        const ARCHETYPES = {
            "Adventurer": { core: ["DEX", "APP"], occupations: ["Archaeologist", "Big Game Hunter", "Bounty Hunter", "Confidence Trickster", "Dilettante", "Entertainer", "Expressman/woman", "Gambler", "Gentleman/lady", "Gunfighter", "Hobo", "Journalist", "Outlaw", "Scout/Mountain Person", "Soldier/Warrior"], bonusSkills: ["Climb", "Drive Coach/Wagon", "First Aid", "Fighting (any)", "Firearms (any)", "Gambling", "Jump", "Language Other (any)", "Mechanical Repair", "Ride", "Stealth", "Survival", "Rope Use", "Swim"], talent: 'Always Onward!', talentDesc: 'Each round you can choose to get a 20% bonus to any roll of your choice. Furthermore, when travelling, you can move an additional D3 hexes per session.' },
            "Beefcake": { core: ["STR"], occupations: ["Bounty Hunter", "Cowboy/girl", "Entertainer", "Farmer", "Gunfighter", "Hired Muscle", "Lawman", "Outlaw", "Person of God", "Pugilist", "Sailor", "Scout/Mountain Person", "Soldier/warrior", "Tribe Member"], bonusSkills: ["Climb", "Fighting (Brawling)", "Intimidate", "Listen", "Mechanical Repair", "Psychology", "Swim", "Throw"], talent: 'Hard Hitter', talentDesc: 'For the purposes of combat maneuvers and bonus damage, you count as having +1 to your Build. Furthermore, for each Build level more you have compared to an opponent, you gain advantage to combat maneuver against them.' },
            "Bon Vivant": { core: ["SIZ"], occupations: ["Artist", "Author", "Big Game Hunter", "Butler", "Confidence Trickster", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Hobo", "Hooker", "Itinerant Worker", "Librarian", "Merchant", "Politician", "Rancher"], bonusSkills: ["Appraise", "Art/Craft (any)", "Charm", "Fast Talk", "Language Other (any)", "Listen", "Spot Hidden", "Psychology", "Gambling"], talent: 'Living Life!', talentDesc: 'You double the HP regained from whiskey and the sanity regained from other pleasures.' },
            "Cold Blooded": { core: ["INT"], occupations: ["Bounty Hunter", "Confidence Trickster", "Doctor", "Gambler", "Gunfighter", "Hired Muscle", "Hooker", "Journalist", "Lawman", "Lawyer/Judge", "Merchant", "Outlaw", "Politician", "Pugilist", "Scientist/Engineer", "Soldier", "Spy", "Zealot"], bonusSkills: ["Art/Craft (Acting)", "Disguise", "Fighting (any)", "Firearms (any)", "First Aid", "Gambling", "History", "Intimidate", "Law", "Listen", "Mechanical Repair", "Psychology", "Stealth", "Survival", "Track", "Trap"], talent: 'All According to Plan', talentDesc: 'Once per encounter, you can count any success as a critical success.' },
            "Egghead": { core: ["INT", "EDU"], occupations: ["Author", "Craftsperson", "Doctor", "Gambler", "Itinerant Worker", "Journalist", "Lawyer/Judge", "Librarian", "Minor", "Student/Teacher", "Scientist/Engineer"], bonusSkills: ["Anthropology", "Appraise", "Electrical Repair", "First Aid", "Gambling", "Language Other (any)", "Library Use", "Mechanical Repair", "Operate Heavy Machinery", "Science", "Trap"], talent: 'Eureka!', talentDesc: 'You can create Gadgets and the difficulty level for any relevant skill is reduced by 1.' },
            "Explorer": { core: ["DEX", "POW"], occupations: ["Author", "Big Game Hunter", "Coachman/woman", "Dilettante", "Expressman/woman", "Gentleman/lady", "Hobo", "Itinerant Worker", "Person of God", "Merchant", "Miner", "Sailor", "Student/Teacher", "Scout", "Tribe Member"], bonusSkills: ["Animal Handling", "Anthropology", "Archaeology", "Climb", "Drive Coach/Wagon", "Fighting (Brawling)", "First Aid", "Jump", "Language Other (any)", "Natural World", "Navigate", "Ride", "Rope Use", "Stealth", "Survival", "Track"], talent: 'Born Traveler', talentDesc: 'The difficulty level for Climb, Natural World, Navigate, Survival and Swim rolls is always reduced by 1 level. Furthermore, when you travel any HP lost due to hazards or the weather is halved.' },
            "Femme Fatale": { core: ["APP", "INT"], occupations: ["Artist", "Bartender", "Bounty Hunter", "Confidence Trickster", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Hooker", "Journalist", "Librarian", "Outlaw", "Politician", "Spy"], bonusSkills: ["Art/Craft (Acting)", "Appraise", "Charm", "Disguise", "Drive Coach/Wagon", "Fast Talk", "Fighting (Brawling)", "Firearms (Handguns)", "Gambling", "Listen", "Psychology", "Read Lips", "Rope Use", "Sleight of Hand", "Stealth", "Trap"], talent: 'Irresistible', talentDesc: 'Charm and Persuade rolls are always reduced by 1 level of difficulty. Furthermore, anyone who fails an opposed roll (Charm vs Charm or POW) suffers disadvantage when targeting you.' },
            "Hard Boiled": { core: ["CON"], occupations: ["Bounty Hunter", "Coachman/woman", "Cowboy/girl", "Farmer", "Gunfighter", "Hired Muscle", "Lawman", "Outlaw", "Person of God", "Pugilist", "Sailor", "Scout", "Soldier", "Zealot"], bonusSkills: ["Fighting (Brawling)", "Firearms (any)", "Drive Coach/Wagon", "Fast Talk", "Intimidate", "Law", "Listen", "Locksmith", "Sleight of Hand", "Spot Hidden", "Rope Use", "Stealth", "Throw"], talent: 'That all you got?', talentDesc: 'You have to lose 75% of your HP in a round to gain a major wound and when you gain a major wound, you do not suffer from disadvantage.' },
            "Hunter": { core: ["INT", "CON"], occupations: ["Big Game Hunter", "Bounty Hunter", "Cowboy/girl", "Dilettante", "Expressman/woman", "Lawman", "Miner", "Outlaw", "Scout", "Tribe Member", "Zealot"], bonusSkills: ["Animal Handling", "Fighting (any)", "Firearms (any)", "First Aid", "Listen", "Natural World", "Navigate", "Spot Hidden", "Ride", "Rope Use", "Stealth", "Survival", "Swim", "Track", "Trap"], talent: 'No Escape', talentDesc: 'Track and Trap rolls are always reduced by 1 level of difficulty and you gain +1 to your Move Rate. When rolling to maintain stamina during chases, you increase the success level by 1.' },
            "Mystic": { core: ["POW"], occupations: ["Artist", "Confidence Trickster", "Craftsperson", "Doctor", "Entertainer", "Gentleman/lady", "Hobo", "Person of God", "Student/Teacher", "Scientist/Engineer", "Tribe Member", "Zealot"], bonusSkills: ["Art/Craft (any)", "Disguise", "History", "Language Other (any)", "Listen", "Natural World", "Occult", "Psychology", "Science", "Sleight of Hand", "Spot Hidden", "Stealth", "Track"], talent: 'Powers', talentDesc: 'Can use Magic (Medium, Telekinesis, Shamanic Magic, Witchcraft).' },
            "Outsider": { core: ["INT", "CON"], occupations: ["Artist", "Craftsperson", "Dilettante", "Entertainer", "Farmer", "Expressman/woman", "Hobo", "Itinerant Worker", "Miner", "Person of God", "Sailor", "Scout", "Tribe Member", "Zealot"], bonusSkills: ["Art/Craft (any)", "Animal Handling", "Fighting (any)", "First Aid", "Intimidate", "Language Other (any)", "Listen", "Medicine", "Navigate", "Stealth", "Survival (any)", "Track"], talent: 'Unorthodox Methods', talentDesc: 'Once per encounter can reverse the roll of a D100 and when an ally fails a roll, the outsider can use the same characteristic or skill against the obstacle/hazard with advantage.' },
            "Rogue": { core: ["DEX", "APP"], occupations: ["Artist", "Bartender", "Confidence Trickster", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Gunfighter", "Hobo", "Hooker", "Lawyer", "Outlaw", "Pugilist", "Spy"], bonusSkills: ["Appraise", "Art/Craft (any)", "Charm", "Disguise", "Fast Talk", "Gambling", "Law", "Locksmith", "Psychology", "Read Lips", "Rope Use", "Sleight of Hand", "Spot Hidden", "Stealth", "Trap"], talent: 'Scoundrel to The Bone', talentDesc: 'Disguise, Fast Talk, Law, Sleight of Hand and Stealth rolls are always reduced by 1 level of difficulty.' },
            "Scholar": { core: ["EDU"], occupations: ["Author", "Butler", "Dilettante", "Doctor", "Gentleman/lady", "Journalist", "Lawyer/Judge", "Librarian", "Merchant", "Politician", "Student/Teacher", "Scientist/Engineer"], bonusSkills: ["Accounting", "Appraise", "Anthropology", "Archaeology", "History", "Language Other (any)", "Law", "Library Use", "Medicine", "Natural World", "Occult", "Psychology", "Science"], talent: 'Um, Actually', talentDesc: 'INT and EDU rolls are always reduced by 1 level of difficulty. Furthermore, when you assist someone and you succeed on an INT or EDU roll, grant an additional +30% success chance.' },
            "Steadfast": { core: ["CON"], occupations: ["Butler", "Cowboy/girl", "Craftsperson", "Doctor", "Expressman/woman", "Farmer", "Gentleman/lady", "Gunfighter", "Hired Muscle", "Lawman", "Person of God", "Politician", "Pugilist", "Soldier", "Tribe Member"], bonusSkills: ["Accounting", "Drive Coach/Wagon", "Fighting (any)", "Firearms (Handguns)", "First Aid", "History", "Intimidate", "Law", "Natural World", "Navigate", "Persuade", "Psychology", "Ride", "Spot Hidden", "Survival"], talent: 'Bulwark of Justice', talentDesc: 'If an ally suffered a major wound or is dying, gain advantage to all rolls. Once per encounter, if an ally within Move Rate is being targeted, you may choose to become the target instead.' },
            "Swashbuckler": { core: ["DEX", "APP"], occupations: ["Artist", "Big Game Hunter", "Dilettante", "Entertainer", "Gambler", "Gentleman/lady", "Gunfighter", "Journalist", "Lawman", "Outlaw", "Sailor"], bonusSkills: ["Art/Craft (any)", "Charm", "Climb", "Dodge", "Fighting (any)", "Jump", "Language Other (any)", "Mechanical Repair", "Navigate", "Rope Use", "Stealth", "Swim", "Throw"], talent: 'Dazzling Heroics', talentDesc: 'So long as you are at full HP, you have advantage on all rolls. Opponents suffer disadvantage when targeting you, unless you suffer from a major wound or are dying.' },
            "Thrill Seeker": { core: ["DEX", "POW"], occupations: ["Big Game Hunter", "Bounty Hunter", "Confidence Trickster", "Dilettante", "Entertainer", "Expressman/woman", "Gambler", "Gunfighter", "Hired Muscle", "Hooker", "Outlaw", "Pugilist", "Sailor", "Soldier", "Spy", "Zealot"], bonusSkills: ["Art/Craft (any)", "Charm", "Climb", "Drive Coach/Wagon", "Fast Talk", "Gambling", "Jump", "Mechanical Repair", "Navigate", "Ride", "Stealth", "Survival", "Swim", "Throw"], talent: 'Adrenaline Junkie', talentDesc: 'When you suffer from a major wound, you have advantage to all your rolls until it is healed (Ignore usual penalties). If you are Dying, you count all rolls as being reduced by 1 difficulty level.' },
            "Two-Fisted": { core: ["STR", "SIZ"], occupations: ["Big Game Hunter", "Bounty Hunter", "Coachman/woman", "Cowboy/girl", "Gunfighter", "Hired Muscle", "Outlaw", "Pugilist", "Scout", "Soldier", "Zealot", "Tribe Member"], bonusSkills: ["Dodge", "Drive Coach/Wagon", "Fighting (Brawling)", "Firearms (any)", "Intimidate", "Listen", "Mechanical Repair", "Spot Hidden", "Swim", "Throw"], talent: 'Get Some!', talentDesc: 'When fighting back, you need the same level of success or better to hit the opponent. Furthermore, when you roll an extreme success, you deal extreme damage, even when fighting back.' }
        };

        const OCCUPATIONS = {
            'Archaeologist': { skillPointsFormula: (edu, dex, pow) => edu * 2 + Math.max(dex * 2, pow * 2), crRange: [6, 60], skills: ['Archaeology', 'History', 'Library Use', 'Spot Hidden', 'Navigate', 'Language Other (any)', 'Anthropology', 'any one other'] },
            'Artist': { skillPointsFormula: (edu, dex, pow) => edu * 2 + Math.max(dex * 2, pow * 2), crRange: [6, 60], skills: ['Art/Craft (any)', 'History', 'Library Use', 'Psychology', 'Spot Hidden', 'Sleight of Hand', 'any two other'] },
            'Author': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 30], skills: ['Art/Craft (Literature)', 'History', 'Library Use', 'Natural World or Occult', 'Language Other', 'Language Own', 'Psychology', 'any one other'] },
            'Bartender': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [8, 25], skills: ['Accounting', 'two interpersonal (Charm, Fast Talk, Intimidate, or Persuade)', 'Fighting (Brawling)', 'Listen', 'Psychology', 'Spot Hidden', 'any one other'] },
            'Big Game Hunter': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [20, 50], skills: ['Firearms (any)', 'Listen or Spot Hidden', 'Natural World', 'Navigate', 'Language Other or Survival', 'Stealth', 'Track', 'Trap'] },
            'Bounty Hunter': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [9, 30], skills: ['Drive Coach/Wagon', 'Fighting or Firearms (any)', 'one interpersonal (Fast Talk, Charm, Intimidate, or Persuade)', 'Law', 'Psychology', 'Rope Use', 'Track', 'Trap', 'Stealth'] },
            'Butler': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 40], skills: ['Accounting or Appraise', 'Art/Craft (any, e.g. Cook, Tailor, Barber)', 'First Aid', 'Listen', 'Language Other', 'Psychology', 'Spot Hidden', 'any two other'] },
            'Coachman/woman': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [10, 40], skills: ['Drive Coach/Wagon', 'two interpersonal (Charm, Fast Talk, Intimidate, or Persuade)', 'Fighting or Firearms (any)', 'Listen', 'Ride', 'Spot Hidden', 'Throw'] },
            'Confidence Trickster': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [20, 60], skills: ['Appraise', 'Art/Craft (Acting)', 'Charm', 'Disguise', 'Fast Talk', 'Gambling', 'Psychology', 'Sleight of Hand', 'Spot Hidden', 'Trap'] },
            'Cowboy/girl': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [9, 25], skills: ['Animal Handling', 'Drive Coach/Wagon or Ride', 'Firearms (Rifle/Shotgun or Handgun)', 'First Aid', 'Listen', 'Natural World', 'Rope Use', 'Survival', 'Track'] },
            'Craftsperson': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 40], skills: ['Art/Craft (any)', 'two other relevant to craft', 'Appraise', 'Electrical Repair', 'Listen', 'Mechanical Repair', 'Spot Hidden', 'any one other'] },
            'Dilettante': { skillPointsFormula: (edu) => edu * 4, crRange: [50, 99], skills: ['Accounting', 'Appraise', 'Art/Craft (any)', 'Firearms (any)', 'Language Other (any)', 'Ride', 'any one other'] },
            'Doctor': { skillPointsFormula: (edu) => edu * 4, crRange: [40, 99], skills: ['First Aid', 'Medicine', 'Psychology', 'Science (Biology, Chemistry, Pharmacy, etc.)', 'any two others'] },
            'Entertainer': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [9, 40], skills: ['Art/Craft (e.g. Actor, Singer, Comedian, Musician etc.)', 'Disguise', 'two interpersonal (Charm, Fast Talk, Intimidate, or Persuade)', 'Listen', 'Psychology', 'any two other'] },
            'Expressman/woman': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [9, 25], skills: ['Animal Handling', 'Drive Coach/Wagon', 'Firearms (any)', 'Listen', 'Navigate', 'Ride', 'Spot Hidden', 'Survival'] },
            'Farmer': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str*2, con*2), crRange: [9, 30], skills: ['Art/Craft (Farming)', 'Firearms (Rifle and Shotgun)', 'Drive Coach/Wagon', 'First Aid', 'Jump', 'Mechanical Repair', 'Natural World', 'Ride', 'Rope Use'] },
            'Gambler': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [20, 50], skills: ['Appraise', 'Fast Talk', 'Gambling', 'Listen', 'Sleight of Hand', 'Spot Hidden', 'any two others'] },
            'Gentleman/lady': { skillPointsFormula: (edu) => edu * 4, crRange: [50, 99], skills: ['Accounting', 'Appraise', 'Art/Craft (any)', 'Drive Coach/Wagon', 'Law', 'Language Other', 'Ride', 'any one other'] },
            'Gunfighter': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [10, 40], skills: ['Drive Coach/Wagon or Ride', 'Fast Talk or Intimidate', 'Firearms (any)', 'Fighting (Brawling)', 'Listen', 'Psychology', 'Spot Hidden', 'Stealth'] },
            'Hired Muscle': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [10, 25], skills: ['Fighting (Brawling)', 'Firearms (any)', 'Intimidate', 'Listen', 'Psychology', 'Stealth', 'Survival', 'Throw'] },
            'Hobo': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [0, 9], skills: ['Listen', 'Navigate', 'Natural World', 'Stealth', 'Survival', 'Track', 'any one other'] },
            'Hooker': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [9, 25], skills: ['Charm', 'Disguise', 'Fast Talk', 'Psychology', 'Sleight of Hand', 'any two others'] },
            'Itinerant Worker': { skillPointsFormula: (edu, str) => edu * 2 + str * 2, crRange: [9, 25], skills: ['Art/Craft (any)', 'Climb', 'Electrical Repair or Mechanical Repair', 'First Aid', 'Listen', 'Spot Hidden', 'Throw'] },
            'Journalist': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 50], skills: ['Art/Craft (Photography or Typing)', 'Fast Talk', 'History', 'Library Use', 'Listen', 'Language Own', 'Persuade', 'Psychology'] },
            'Lawman': { skillPointsFormula: (edu, con) => edu * 2 + con * 2, crRange: [10, 40], skills: ['Firearms (Handguns)', 'Fighting (Brawling)', 'Intimidate', 'Law', 'Listen', 'Persuade', 'Psychology', 'Spot Hidden', 'Ride'] },
            'Lawyer/Judge': { skillPointsFormula: (edu) => edu * 4, crRange: [20, 80], skills: ['Fast Talk', 'Law', 'Library Use', 'Language Own', 'Persuade', 'Psychology', 'any one other'] },
            'Librarian': { skillPointsFormula: (edu) => edu * 4, crRange: [9, 40], skills: ['Accounting', 'Anthropology or Archaeology', 'History', 'Library Use', 'Occult', 'Language Own', 'any one other'] },
            'Merchant': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [20, 70], skills: ['Accounting', 'Appraise', 'Fast Talk', 'Listen', 'Persuade', 'Psychology', 'Spot Hidden', 'any one other'] },
            'Miner': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [9, 25], skills: ['Climb', 'Electrical Repair or Mechanical Repair', 'Jump', 'Listen', 'Navigate', 'Ride', 'Spot Hidden', 'Survival'] },
            'Outlaw': { skillPointsFormula: (edu, dex, str) => edu * 2 + Math.max(dex * 2, str * 2), crRange: [0, 9], skills: ['Drive Coach/Wagon or Ride', 'Firearms (any)', 'Fighting (any)', 'Fast Talk or Intimidate', 'Mechanical Repair', 'Stealth', 'Survival'] },
            'Person of God': { skillPointsFormula: (edu, pow) => edu * 2 + pow * 2, crRange: [9, 40], skills: ['History', 'Library Use', 'Listen', 'Medicine', 'Persuade', 'Psychology', 'any two others'] },
            'Politician': { skillPointsFormula: (edu, app) => edu * 2 + app * 2, crRange: [30, 80], skills: ['Fast Talk', 'Law', 'Persuade', 'Psychology', 'History', 'Language Own', 'any two others'] },
            'Pugilist': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [9, 25], skills: ['Dodge', 'Fighting (Brawling)', 'First Aid', 'Intimidate', 'Listen', 'Psychology', 'any two others'] },
            'Rancher': { skillPointsFormula: (edu, str) => edu * 2 + str * 2, crRange: [10, 40], skills: ['Animal Handling', 'Appraise', 'Art/Craft (any)', 'Drive Coach/Wagon', 'Listen', 'Natural World', 'Ride', 'Rope Use', 'Survival', 'Track'] },
            'Sailor': { skillPointsFormula: (edu, str, con) => edu * 2 + Math.max(str * 2, con * 2), crRange: [9, 25], skills: ['Climb', 'Fighting (Brawling)', 'Listen', 'Navigate', 'Jump', 'Mechanical Repair', 'Rope Use', 'Swim', 'Throw'] },
            'Scout/Mountain Person': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [9, 30], skills: ['Climb', 'Listen', 'Natural World', 'Navigate', 'Ride', 'Spot Hidden', 'Stealth', 'Survival', 'Track'] },
            'Scientist/Engineer': { skillPointsFormula: (edu) => edu * 4, crRange: [20, 80], skills: ['Electrical Repair', 'Library Use', 'Mechanical Repair', 'Science (any)', 'any four others'] },
            'Soldier/Warrior': { skillPointsFormula: (edu, dex, str, con) => edu * 2 + Math.max(dex * 2, str * 2, con * 2), crRange: [9, 30], skills: ['Dodge', 'Fighting (any)', 'Firearms (any)', 'Intimidate', 'Listen', 'Stealth', 'Survival', 'any one other'] },
            'Spy': { skillPointsFormula: (edu, dex) => edu * 2 + dex * 2, crRange: [9, 50], skills: ['Disguise', 'Fast Talk', 'Listen', 'Persuade', 'Psychology', 'Read Lips', 'Sleight of Hand', 'Stealth'] },
            'Student/Teacher': { skillPointsFormula: (edu, int) => edu * 2 + int * 2, crRange: [9, 25], skills: ['Appraise', 'History', 'Language Other', 'Library Use', 'Occult', 'Language Own', 'Persuade', 'Psychology', 'Science'] },
            'Tribe Member': { skillPointsFormula: (edu, pow) => edu * 2 + pow * 2, crRange: [9, 25], skills: ['Listen', 'Natural World', 'Navigate', 'Occult', 'Stealth', 'Survival', 'Swim', 'Track'] },
            'Zealot': { skillPointsFormula: (edu, pow, con) => edu * 2 + Math.max(pow * 2, con * 2), crRange: [9, 25], skills: ['History', 'Intimidate', 'Listen', 'Persuade', 'Psychology', 'any two others'] },
            'Lawyer': { skillPointsFormula: (edu) => edu * 4, crRange: [20, 80], skills: ['Fast Talk', 'Law', 'Library Use', 'Language Own', 'Persuade', 'Psychology', 'any one other'] }
        };

        const HINDRANCES = {
            'Blind (7)': {value: 7, desc: 'You can’t see shit! You suffer -80% to any skill that requires sight (Most skills, but Keeper’s discretion). You increase the difficulty level of Spot Hidden rolls by 2.'},
            'Ailin\' (6)': {value: 6, desc: 'You suffer from an uncurable chronic illness, be it cholera, tuberculosis or lead poisoning. Your time is limited, so make the best of it. Your ailment will eventually kill you, no matter what. You have disadvantage to all STR and CON rolls. You permanently have the Dying condition (The difficulty level of all your rolls is increased 1 if you reach 0 HP or have a major wound). At the beginning of each session (before recovering Luck), you must take a LUCK and CON roll. If you fail either, your condition worsens. You lower your STR and CON by D10. A critical failure means you lose 2D10. Once your STR or CON reaches 0, you die.'},
            'Cursed (5)': {value: 5, desc: 'Whether real or imagined, you truly feel like you\'ve been cursed. Nothing goes your way, in fact, it often seems Lady Luck enjoys mocking you. Half your LUCK. Whenever you recover LUCK, half the result. When you fumble, the result is always really bad (Keeper\'s discretion). Animals do not like you and will often react aggressively to you.'},
            'Thin-Skinned (5)': {value: 5, desc: 'Some people just aren\'t cut out for the rough life of the West. Whenever you suffer damage, you suffer 1 additional damage. When making opposed rolls, always suffer disadvantage (Including fighting back during combat).'},
            'Grim Servant O\' Death (4)': {value: 4, desc: 'Wherever you go, death follows. You must be one of the Grim Reaper\'s favorites! Whenever you fumble, you target an ally (Death gets real creative). If there are no allies, you target an innocent bystander. Hurting everyone you meet, and innocents will lower your sanity bit by bit and make forming connections real difficult.'},
            'Death Wish (4)': {value: 4, desc: 'Your life ain\'t worth much and you know it. To flee, you must succeed in a Hard POW roll or stay in the fight/situation (yes that includes avalanches, tornadoes and whatever else). You cannot use Luck to avoid certain death.'},
            'Night Terrors (4)': {value: 4, desc: 'To say you have bad dreams is a severe understatement. You must take a Hard POW roll at the beginning of each session. If you fail, you can choose to either lose D6 sanity points or suffer disadvantage to all rolls until next session.'},
            'Maimed (4)': {value: 4, desc: 'Lost that during the war partner? Start with a serious, detrimental, permanent injury (Lost leg, arm, eye, etc.....).'},
            'Pacifist (4)': {value: 4, desc: 'You despise violence, even when it is necessary. To partake in any violence (if justifiable), you must succeed in an Extreme POW roll. To retaliate against violence (if justifiable), you must succeed in a Hard POW roll.'},
            'Loco (3)': {value: 3, desc: 'You never were all there, were you partner? When you roll to see how much sanity you lose, roll the result twice and pick the highest one.'},
            'Heroic (3)': {value: 3, desc: 'As a noble soul, you never say no to a person in need. You can\'t let innocents hurt or suffer, you will always intervene or help them, free of charge of course. You do not lie, cheat or act outside the law, unless the law itself is unjust (Keeper\'s discretion). Letting innocents getting hurt is a good way to lose sanity.'},
            'Tenderfoot (3)': {value: 3, desc: 'Every little of cut and scrape makes you cry for your mama. Whenever you are not at full HP, you suffer -10% to all rolls. Whenever you have a major wound, the difficulty level of all your rolls is increased by 1 (does not stack when dying).'},
            'Trouble Magnet (3)': {value: 3, desc: 'Watch out for bumbling butterfingers over here. You increase your fumble chance for all rolls by 5%.'},
            'Bloodthirsty (3)': {value: 3, desc: 'Unlike the Grim Servant of Death, you\'re not unlucky, you just enjoy seeing the light leave their eyes. You never take prisoners or just wing your opponents, which creates a lot of enemies and makes the law take notice real quick. Whenever you want to not kill a person (for the smallest slight), you must take a Hard POW roll or kill them anyway, usually before you can learn any precious information from them. Not killing is a good way to lose sanity.'},
            'Yellow-Belly (3)': {value: 3, desc: 'Not everyone\'s got cold ice-water in their veins. You increase the difficulty level of POW rolls by 1. Intimidation rolls always counts as one level higher of success against you.'},
            'Mute (3)': {value: 3, desc: 'Not the verbose kind of a fella, hey partner? You cannot communicate by talking in any language (You cannot raise alarms, formulating plans in combat might be harder, etc.....). You cannot speak any languages. You increase the difficulty level of Charm, Fast Talk and Persuade rolls by 1.'},
            'Big Britches (3)': {value: 3, desc: 'Fan of extra lards with your beans huh? For the purposes of being hit, increase your Build by 1. Your Move Rate is lowered by 1 (Even when on horseback). When rolling to maintain stamina (during chases), you increase the difficulty level by 1 (Unless you get real creative!).'},
            'Phobia (3)': {value: 3, desc: 'Why are you hiding, it\'s just a rat?! You gain a random phobia (or determined if discussed with Keeper). When you encounter your phobia, you lose 2D10 sanity points and automatically count as suffering from a Bout of Madness.'},
            'Drunkard (2/3)': {value: 2, desc: 'Wherever you go, you\'re the town drunk! When you can drink, you do, unless you succeed in a Hard/Extreme POW roll. When you drink, you always do so excessively.'},
            'Gamblin\' Man (2/3)': {value: 2, desc: 'How about one more round partner? When you can gamble, you do, unless you succeed in a Hard/Extreme POW roll. When you do start gambling, you can\'t help but push your luck (Who needs a horse and gun anyway?).'},
            'All Thumbs (2)': {value: 2, desc: 'Either you wash your hands in slippin\' oil every morning or you just real clumsy. You suffer disadvantage to all Sleight of Hand, Locksmith, Operate Heavy Machinery and repair rolls. You cannot Quick Reload.'},
            'Obligation (2)': {value: 2, desc: 'Whether it\'s debt or a family you have to take care of, you have responsibilities you must attend to. Discuss the exact nature of your obligation with your Keeper. Each week, you will have to lose credit, sanity or any other appropriate resource to represent your time spent on your obligations (A cut of your robbery earnings, money spend on sending constant letters back home, losing sanity when you don\'t attend to your obligations, being vulnerable when tending to these obligations, etc....).'},
            'Shamed (2)': {value: 2, desc: 'Some past action haunts you and some people remember... You must choose a place or faction that has shamed you for some reason or other. You are not well-treated or liked in this place. They will most likely shoot on sight if they get a good look at you!'},
            'Ugly (2)': {value: 2, desc: 'Now that is a face only a mama could love! You increase the difficulty level of APP, Charm and Persuade rolls by 1.'},
            'Lyin\' Eyes (2)': {value: 2, desc: 'Lies just don\'t come easy to you and a sharp eye can tell. You suffer disadvantage when rolling for Disguises, Fast Talk, Gamble, Persuade, Intimidate and Charm.'},
            'Talisman (2)': {value: 2, desc: 'To call on your special talents, you need your lucky deck of cards (or staff, bible, cane, etc....). Only a character with the Powers talent (see Mystic archetype) can take this hindrance. You cannot use your powers without your talisman on you.'},
            'Old Ways Oath (2)': {value: 2, desc: 'You made an oath to forego modern technology and firearms to honor the land itself. You cannot under any circumstance, use guns or "modern" technology (Keeper\'s discretion).'},
            'Mean (2)': {value: 2, desc: 'Who pissed in your coffee?! You do not do things for free. Your reputation will usually suffer, even when you do the right thing! You suffer disadvantage to Charm and Persuade rolls.'},
            'Wanted (2)': {value: 2, desc: 'Whether you actually did it or not, the law thinks you did! You are wanted for a major crime (sentence being death) by one of the following factions (Your choice): The United Federal States of America, The Southern Confederate States of America, The Native Alliance or The Railway Association.'},
            'Miser (2)': {value: 2, desc: 'Scrooge\'s got nothing on you! You half your current Spending Level (at all times). Whenever you wish to part with cash, you must succeed a Hard POW roll or decide to not spend it (must wait until next session to try again).'},
            'Arrogant (2)': {value: 2, desc: 'You don\'t think you\'re the best, you ARE the best and you can\'t handle it when someone proves otherwise. Whenever you flee from combat, back down or someone bests you in any form, you lose D6 sanity. When you defeat a worthy opponent (Keeper\'s discretion) you must take a Hard INT roll. If you fail, you let them live (You will even fight allies who try to intervene).'},
            'Bad Eyes (2)': {value: 2, desc: 'You just can\'t see that good, unless you got yourself a pair of fancy pants spectacles. When you shoot beyond your Point Blank range, you suffer disadvantage to hit. You increase the difficulty level of Spot Hidden rolls by 1. You ignore these penalties if you wear glasses (2-10$), which break if you suffer a Major Wound or can break if you fumble.'},
            'Laws O\' The West (2)': {value: 2, desc: 'You have a strict code that you won\'t break for any reason. You keep your word, do not betray people\'s trust and do not abuse or kill your enemies. Whenever you act in an un-gentleman or -ladylike behavior (Keeper\'s discretion), you lose sanity (This includes killing outside of strict self-defense).'},
            'High Fallutin\' (2)': {value: 2, desc: 'You turn your nose up so high you might drown when it rains. You increase the difficulty level of Charm, Disguise, Fast Talk and Persuade by 1 when talking to those with a lower Credit Rating than yourself. You lose sanity points if your Spending Level is not at a wealthy level.'},
            'Hesitant (2)': {value: 2, desc: 'You always overthink your move, partner. You suffer disadvantage when determining DEX order at the beginning of combat.'},
            'Sensitive Constitution (1)': {value: 1, desc: 'Your body ain\'t got the temperament for nature and it ails. When resisting the effects of poisons, diseases or the weather, you count as having rolled 1 level of success lower.'},
            'Loose Lips (1)': {value: 1, desc: 'You just love blabbin\', to anyone about anything, even if it\'s better to keep your mouth shut sometimes. You can\'t help but divulge your secrets and escapades to anyone you meet on a INT roll (What crimes you committed, plan on committing, where you\'re heading, who you dislike, who you like, etc.....).'},
            'Can\'t Swim (1)': {value: 1, desc: 'Whenever you hit the water, you sink like a rock. When submerged in water, you immediately start drowning.'},
            'Clueless (1)': {value: 1, desc: 'You don\'t pay much attention to anything not in your direct vicinity. You suffer disadvantage to all EDU and relevant skill rolls (Keeper\'s discretion, but to be discussed at character creation). Affects anything the character is not specialized in (A scholar might suffer disadvantage to Survival, a hermit might suffer disadvantage to Science and Anthropology, a gunslinger to Library Use and Law, etc.....).'},
            'Curious (1)': {value: 1, desc: 'It killed the cat and might just kill you, but you can\'t help yourself! To resist temptation to peek at what you should not peak, to go where you should not go or ask when you should not ask, you must take a combined INT and POW roll. Not satisfying your curiosity might cause you to lose sanity points (Keeper\'s discretion).'},
            'Illiterate (1)': {value: 1, desc: 'You cannot read or write and math ain\'t your strong suit neither. You cannot read or write in any language (affects all relevant skills, Kepper\'s discretion).'},
            'Hankerin\' Habit (1)': {value: 1, desc: 'You have a consistent, if not strange, habit that you can\'t help but do everyday, in the same exact way. Decide what your daily habit is (Drinking the same drink every morning at 8am, rolling dice when you wake up or brushing your horse before you go to bed). This habit always leaves you vulnerable and makes you predictable.'},
            'Hard of Hearin\' (1)': {value: 1, desc: 'WHAAAAT?! You increase the difficulty level of Listen rolls by 1.'},
            'Impulsive (1)': {value: 1, desc: 'True daredevil ain\'t yeah, always leaping before you look! You always escalate a situation if you fail a combined INT and POW roll. This means you turn a disagreement into a violent disagreement, a friendly cuss out into a serious insult, a bar-room brawl into a deadly knife fight.'},
            'Mild Mannered (1)': {value: 1, desc: 'Clean, polite and usually overly educated, you are not the most threatening individual. You suffer disadvantage to Intimidate and Fast Talk.'},
            'Vow (1)': {value: 1, desc: 'You swore you would see this through, and you will, no matter what. You must constantly pursue to accomplish this vow, as not doing so takes its toll on your sanity. Discuss details with your Keeper.'},
            'Heavy Sleeper (1)': {value: 1, desc: 'A thunderstorm from hell won\' even wake you up once you close your eyes. When sleeping, anyone sneaking up on you counts as rolling a critical success. You will not wake from your slumber, unless someone attacks you and even then, you will wake up after they at least damaged you!'},
            'Slowpoke (1)': {value: 1, desc: 'Molasses on a cold day move faster than you. You reduce your Move Rate by 1 (on foot).'},
            'Superstitious (1)': {value: 1, desc: 'Owls never hoot "just for the Hell of it," and black cats should be shot if they try to cross your path. Everyone knows that! You suffer double the loss of sanity from strange encounters.'},
            'Tongue-Tied (1)': {value: 1, desc: 'You always flub your one-liners and insults, better let your gun do the barking. You suffer -10% to Charm, Fast Talk, Intimidate, Persuade and Languages.'}
        };

        const TALENTS = {
            'True Grit (7)': {value: 7, desc: 'Backing down just ain\'t in your blood partner! At the beginning of each session, your recover POW in the same way you do Luck. You have advantage to all POW rolls.'},
            'Fast as Lightnin\' (6)': {value: 6, desc: 'Faster than their own shadow this one. You count all DEX rolls as 1 level of success higher. Unless someone else has this talent, you always go first in any combat. Unless someone else has this talent, gain an additional action in the first round of combat.'},
            'Meanest of the Bunch (5)': {value: 5, desc: 'You are one of the meanest hombre\'s to walk the West. Whenever you do damage you roll an additional damage die of the same type (So a cattleman revolver would deal 3D6 damage in your hands, rather than 2D6). Includes an additional Damage Bonus die when brawling.'},
            'Reputation (5)': {value: 5, desc: 'You already earned yourself quite the reputation in these parts\' hombre. You start with the "Depend who\'s Asking" reputation and a nickname of choice.'},
            'Tough as Nails (4)': {value: 4, desc: 'You chew razor-blades for breakfast and persevere no matter what. You count all CON rolls as 1 level of success higher. You only ever take base damage, ignoring brutal and vicious damage (Though extreme damage still applies).'},
            'Veteran o\' The West (4)': {value: 4, desc: 'You may distribute an additional 50 points in any Characteristic or skill (still can\'t go over their limits).'},
            'Guts (3)': {value: 3, desc: 'You got some real sand in ya! You increase the success level of POW rolls by 1. Intimidation rolls always counts as one level lower of success against you.'},
            'Dinero (3)': {value: 3, desc: 'Money talks, it just so happens you talk a lot. You increase your credit rating by 1 level. You can always wire "home" to ask for some money. With enough time, collateral and excuses, you can always get your hands on some extra cash (Keeper\'s discretion).'},
            'Duelist (3)': {value: 3, desc: 'Maybe not the fastest gun in the West, but you have won your fair share of duels. During a duel, you have advantage to all rolls.'},
            'Hip-Shooter (3)': {value: 3, desc: 'When levering or fanning, you suffer -5% to each consecutive shot, rather than -10%.'},
            'Level-Headed (3)': {value: 3, desc: 'Any gunman knows speed is overrated compared to keeping your cool. Opponents do not get the Outnumbered bonus against you. At the beginning of each of your turns, you may choose to ignore one penalty you are suffering from (Keeper\'s discretion).'},
            'Friends in High Places (3)': {value: 3, desc: 'It ain\'t about who you know, but who knows you. Discuss with the Keeper the exact nature of your benefactor (A politician, military captain, a sherif, newspaper editor, etc....). Your benefactor needs to be a powerful figure, someone with the means to help you out in most situations (though their patience is not endless).'},
            'Born Killer (3)': {value: 3, desc: 'You just got a talent for killin\' folk. You can re-roll a damage die each time you cause damage (Can be a DB die).'},
            'Sharpshooter (3)': {value: 3, desc: 'Hell, you can shoot a gnat\'s ass off from a hundred yards! As long as you do not move, you increase the success level of your ranged hits by 1 when using rifles (not applicable in duels).'},
            'Silver-Tongued (3)': {value: 3, desc: 'You truly have a gift for words, an endless cascade of grammatical poetry! You have advantage to all Charm, Fast talk, Language and Persuade rolls.'},
            'Wilderness Man (3)': {value: 3, desc: 'They call you wild, but really you just make the great outdoors civilized! You have advantage all Natural World, Navigate, Survival, Track and Trap rolls. Travelling through difficult terrain does not slow you down.'},
            'Thick-Skinned (3)': {value: 3, desc: 'You can handle more than a little pain. Whenever you suffer damage, you subtract D3 from the received damage (for each individual instance, aka per bullet or stab wound).'},
            'Agent (2)': {value: 2, desc: 'You don\'t work alone partner. You might have to do some work for whoever\'s above you, but at least you can count on some support from time to time. You work for one of the following factions (Your choice): The United Federal States of America, The Southern Confederate States of America, The Native Alliance or The Railway Association. You may ask reasonable support from them (Funds, military aid, gear, etc....), but will have to work for their benefit and report to them.'},
            'Born in The Saddle (2)': {value: 2, desc: 'You spent so much time on horseback or with reins in your hand, people might just think your half-horse yourself. You have advantage on all riding and driving rolls (including combined rolls involving either).'},
            'Brawny (2)': {value: 2, desc: 'Your mama been feeding you well! You have advantage to STR and SIZ rolls.'},
            'Eagle Eyes (2)': {value: 2, desc: 'You increase the success level of Spot Hidden rolls by 1. You ignore the penalties to hit from weather effects.'},
            'Fisticuffs (2)': {value: 2, desc: 'Nothing like a dozen saloon fights to teach you what\'s what. Opponents do not get the Outnumbered and Armed vs Unarmed bonus against you in melee. In melee you can re-roll 1 DB die each time you cause damage.'},
            'Deadeye (2)': {value: 2, desc: 'Throats, eyes and hearts are the only thing worth shooting at. You cause brutal damage with ranged weapons.'},
            'Loyal Companion (2/3)': {value: 2, desc: 'Zoro had Tornado, so what\'s your loyal pet/mount called? Discuss with the GM what type of animal you would want, with what traits and talents. A cat, dog or parrot count as 2, but a horse, bear or buffalo will most likely be a 3.'},
            'Tinkerer (2)': {value: 2, desc: 'You have advantage to all Locksmith, Operate Heavy Machinery and repair rolls.'},
            'Nerves O\' Steel (2)': {value: 2, desc: 'Nothing rattles you. Well, almost nothing. You have advantage to POW rolls. When you lose sanity, you only lose half.'},
            'Nimble (2)': {value: 2, desc: 'Rollin\' and jumpin\' are just second nature to you. Useful in a gunfight that. When you dive for cover, you can still move and do not suffer disadvantage to your next roll.'},
            'Purty (2)': {value: 2, desc: 'What\'s cookin\' good lookin ? You have advantage to APP and Charm rolls.'},
            'Quickdraw (2)': {value: 2, desc: 'Not quite fast, but quite quick. You gain +50% DEX roll to determine who goes first in combat (including duels).'},
            'Big Swings (2)': {value: 2, desc: 'Your Damage Bonus causes brutal damage.'},
            'Speed Loader (2)': {value: 2, desc: 'When you Quick Reload, load DEX/10 bullets or shells in your gun and shoot (with no disadvantage).'},
            'Ambidextrous (1)': {value: 1, desc: 'Both hands, equally nimble. You do not suffer penalties for shooting with your off-hand.'},
            'Animal Lover (1)': {value: 1, desc: 'Animals can sense your good nature. You count all Animal Handling rolls as 1 level of success higher. You may attempt to calm down aggressive animals with an Animal Handling roll (Keeper\'s discretion).'},
            'Belongin\'s (1)': {value: 1, desc: 'Whether it\'s a lucky rabbit\'s foot or your daddy\'s war pistol, you did not walk into the frontier empty-handed. In addition to anything you might buy, you may choose to own a special item. Discuss the exact nature of what you want with your Keeper (About 15$ limit).'},
            'Eavesdropper (1)': {value: 1, desc: 'You increase the success level of Listen rolls by 1.'},
            'Gallows Humor (1)': {value: 1, desc: 'Some people just laugh at the Grim Reaper, or at least at some of his irony. If you lose sanity (without triggering a bout of madness) you can roll Charm or Fast Talk. If you succeed, you only lose half of your sanity and if your allies can hear, they only lose half.'},
            'Card Sharp (1)': {value: 1, desc: 'Little bit of talent, little bit of cheating and voila! You have advantage on Gamble and Sleight of Hand rolls.'},
            'Keen (1)': {value: 1, desc: 'You notice the little things. You have advantage to Spot Hidden, Track and Listen.'},
            'Kemosabe (1)': {value: 1, desc: 'You travelled enough to know smart folk adapt themselves to their surroundings. Do not suffer (social) penalties when interacting with a group as an "outsider" (A northerner interacting with southerners, a native interacting with non-natives, an atheist interacting with religious folk, etc..).'},
            'Fate\'s Favored (1/2/3)': {value: 1, desc: 'Lady luck ain\'t no fickle mistress to you, but a loyal spouse. Gain +10/+20/+30 Luck points to your maximum (Cannot bring it over the maximum).'},
            'Fleet-Footed (1)': {value: 1, desc: 'You gain +1 to your Move Rate (on foot).'},
            'Light Sleeper (1)': {value: 1, desc: 'The slightest twig-crack is enough for you shoot-awake. When sleeping, anyone sneaking up on you must succeed a Hard stealth roll. You wake up instantly, meaning you roll initiative in the same round if you do!'},
            'Locked and Loaded (1)': {value: 1, desc: 'No matter when, what, who or where, you\'re always ready. In the first round of combat, you cannot fumble.'},
            'Iron Liver (1)': {value: 1, desc: 'If your liver could absorb bullets like it does whiskey, you\'d be immortal. When you take a CON roll to resist the effects of alcohol, you always count your roll as 1 level of success higher.'},
            'Gift of Gab (1)': {value: 1, desc: 'You got a real knack for entertaining and story-telling. You count all Fast Talk rolls as 1 level of success higher.'},
            'Evil Eye (1)': {value: 1, desc: 'Your eyes just got that killer\'s edge. You have advantage to Intimidation rolls. In a duel, you count your roll during the Stare Down as 1 level of success higher.'},
            'Luck O\' The Irish (1)': {value: 1, desc: 'When you decide to use "My Hat!", you lose D3 slots worth of items, rather than D6.'},
            'Mule Man (1)': {value: 1, desc: 'You got that strong, good for haulin\' physique! You can carry an additional 3 slots.'},
            'War Cry (1)': {value: 1, desc: 'A blood-curdling yell that emboldens you and terrifies opponents. You roll Intimidation, against which opponents within your STR/10 spaces may roll Intimidation or POW. If you win, opponents suffer disadvantage to their next actions. Can only be used once per encounter.'},
            'Ruthless (1)': {value: 1, desc: 'You done worse than most and aren\'t easily impressed. You do not lose sanity for killing, torturing or seeing gruesome sights.'}
        };
        
        const ALL_SKILLS = {
            'Accounting': {base: 5}, 'Animal Handling': {base: 5}, 'Anthropology': {base: 1}, 'Appraise': {base: 5}, 'Archaeology': {base: 1}, 
            'Charm': {base: 15}, 'Climb': {base: 20}, 'Credit Rating': {base: 0}, 'Demolitions': {base: 1}, 
            'Disguise': {base: 5}, 'Dodge': {base: 0}, 'Drive Coach/Wagon': {base: 20}, 'Electrical Repair': {base: 0}, 'Fast Talk': {base: 5}, 
            'First Aid': {base: 30}, 'Gambling': {base: 10}, 'History': {base: 5}, 'Intimidate': {base: 15}, 'Jump': {base: 20}, 
            'Law': {base: 5}, 'Library Use': {base: 20}, 'Listen': {base: 20}, 
            'Locksmith': {base: 1}, 'Mechanical Repair': {base: 10}, 'Medicine': {base: 1}, 'Natural World': {base: 20}, 'Navigate': {base: 10}, 
            'Occult': {base: 5}, 'Operate Heavy Machinery': {base: 1}, 'Persuade': {base: 10}, 'Psychology': {base: 10}, 'Read Lips': {base: 1}, 
            'Ride': {base: 20}, 'Rope Use': {base: 5}, 'Sleight of Hand': {base: 10}, 'Spot Hidden': {base: 25}, 
            'Stealth': {base: 20}, 'Survival': {base: 10}, 'Swim': {base: 20}, 'Throw': {base: 20}, 'Track': {base: 10}, 'Trap': {base: 10},
            // Specific Fighting/Firearms skills
            'Firearms (Handguns)': {base: 20}, 'Firearms (Rifles)': {base: 25}, 'Firearms (Shotguns)': {base: 25}, 'Firearms (Missile Weapons)': {base: 15},
            'Fighting (Brawling)': {base: 25}, 'Fighting (Swords)': {base: 15}, 'Fighting (Indigenous Weapons)': {base: 20},
            // Psychic Skills
            'Medium': {base: 0}, 'Telekinesis': {base: 0}, 'Shamanic Magic': {base: 0}, 'Witchcraft': {base: 0},
             // Base skills that are templates for specialties
            'Language Own': {base: 0}, 'Language Other': {base: 0, isSpecialty: true}, 'Art/Craft': {base: 5, isSpecialty: true}, 'Science': {base: 1, isSpecialty: true}
        };

        const SKILL_CATEGORIES = {
            "Fighting": ["Fighting (Brawling)", "Fighting (Swords)", "Fighting (Indigenous Weapons)"],
            "Firearms": ["Firearms (Handguns)", "Firearms (Rifles)", "Firearms (Shotguns)", "Firearms (Missile Weapons)", "Throw"],
            "Social": ["Charm", "Disguise", "Fast Talk", "Intimidate", "Persuade", "Psychology"],
            "Knowledge": ["Accounting", "Anthropology", "Archaeology", "History", "Language Own", "Language Other", "Law", "Library Use", "Medicine", "Occult", "Science"],
            "Physical": ["Climb", "Drive Coach/Wagon", "Jump", "Ride", "Stealth", "Swim"],
            "Survival & Perception": ["Animal Handling", "First Aid", "Gambling", "Listen", "Natural World", "Navigate", "Read Lips", "Sleight of Hand", "Spot Hidden", "Survival", "Track", "Trap"],
            "Technical & Craft": ["Appraise", "Art/Craft", "Demolitions", "Electrical Repair", "Locksmith", "Mechanical Repair", "Operate Heavy Machinery", "Rope Use"],
            "Psychic": ["Medium", "Telekinesis", "Shamanic Magic", "Witchcraft"],
            "Core": ["Credit Rating", "Dodge"]
        };


        const charList = ['STR', 'CON', 'DEX', 'POW', 'APP', 'EDU', 'INT', 'SIZ'];

        let character = {
            archetype: null,
            occupation: null,
            characteristics: {},
            skills: {},
            talents: [],
            hindrances: [],
            age: null,
            luck: 0,
            heritageText: ''
        };

        let coreCharacteristic = null;
        let coreRollValue = 0;
        const totalCharPoints = 460;
        let specialtySkillCounter = 0;

        // Initialize
        function init() {
            populateSelect('archetype-select', Object.keys(ARCHETYPES));
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">Select...</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        function nextStep(step) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
            if (step === 6) calculateAndDisplaySkillPoints();
            if (step === 7) {
                populateHindSelect();
                populateTalSelect();
                const arch = ARCHETYPES[document.getElementById('archetype-select').value];
                document.getElementById('arch-talent').textContent = arch.talent;
            }
        }

        function prevStep(toStep) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${toStep}`).classList.remove('hidden');
        }

        function displayArchetypeInfo() {
            const select = document.getElementById('archetype-select');
            const infoDiv = document.getElementById('archetype-info');
            const archetypeKey = select.value;

            if (!archetypeKey) {
                infoDiv.classList.add('hidden');
                return;
            }

            const archetype = ARCHETYPES[archetypeKey];
            infoDiv.innerHTML = `
                <h4>Core Characteristic(s):</h4>
                <p>${archetype.core.join(', ')}</p>
                <h4>Archetype Talent: ${archetype.talent}</h4>
                <p>${archetype.talentDesc}</p>
                <h4>Bonus Archetype Skills:</h4>
                <ul>
                    ${archetype.bonusSkills.map(skill => `<li>${skill}</li>`).join('')}
                </ul>
                <h4>Allowed Occupations:</h4>
                <p>${archetype.occupations.join(', ')}</p>
            `;
            infoDiv.classList.remove('hidden');
        }

        function displayOccupationInfo() {
            const select = document.getElementById('occupation-select');
            const infoDiv = document.getElementById('occupation-info');
            const occupationKey = select.value;

            if (!occupationKey) {
                infoDiv.classList.add('hidden');
                return;
            }

            const occupation = OCCUPATIONS[occupationKey];
            infoDiv.innerHTML = `
                <h4>Occupation Skills:</h4>
                <ul>
                    ${occupation.skills.map(skill => `<li>${skill}</li>`).join('')}
                </ul>
            `;
            infoDiv.classList.remove('hidden');
        }

        function selectArchetype() {
            const value = document.getElementById('archetype-select').value;
            if (!value) return alert("Please select an Archetype.");
            character.archetype = ARCHETYPES[value];
            populateSelect('occupation-select', character.archetype.occupations);
            updateCoreCharSelect();
            // Clear occupation info when archetype changes
            document.getElementById('occupation-info').classList.add('hidden');
            document.getElementById('occupation-select').value = '';
            nextStep(2);
        }

        function selectOccupation() {
            const value = document.getElementById('occupation-select').value;
            if (!value) return alert("Please select an Occupation.");
            character.occupation = OCCUPATIONS[value];
            nextStep(3);
        }

        function updateCoreCharSelect() {
            populateSelect('core-char-select', character.archetype.core);
            updateCharacteristicInputs();
        }

        function rollCore() {
            const value = document.getElementById('core-char-select').value;
            if (!value) return alert("Please select a core characteristic first.");
            updateCharacteristicInputs();
            coreCharacteristic = value;
            const d6 = Math.floor(Math.random() * 6) + 1;
            coreRollValue = 65 + d6 * 5;
            document.getElementById('core-roll-display').textContent = coreRollValue;
            const input = document.getElementById(value);
            input.value = coreRollValue;
            input.min = coreRollValue;
            updateRemainingPoints();
        }

        function updateCharacteristicInputs() {
            const div = document.getElementById('char-alloc');
            div.innerHTML = '';
            charList.forEach(char => {
                const group = document.createElement('div');
                group.className = 'char-input-group';
                group.innerHTML = `<label for="${char}">${char}:</label><input type="number" id="${char}" value="15" min="15" max="130" oninput="updateRemainingPoints()">`;
                div.appendChild(group);
            });
            document.getElementById('core-roll-display').textContent = 'Not rolled yet';
            coreCharacteristic = null;
            coreRollValue = 0;
            updateRemainingPoints();
        }

        function updateRemainingPoints() {
            let spent = 0;
            document.querySelectorAll('#char-alloc input[type="number"]').forEach(i => spent += +i.value || 0);
            document.getElementById('remaining-points').textContent = totalCharPoints + coreRollValue - spent;
        }

        function completeChars() {
            if (!coreCharacteristic || !coreRollValue) return alert("Please roll for a core characteristic first.");
            const inputs = [...document.querySelectorAll('#char-alloc input[type="number"]')];
            let spent = 0, errors = [];
            inputs.forEach(input => {
                const val = +input.value;
                if (isNaN(val) || val < +input.min || val > 130) errors.push(`${input.id} must be ${input.min}-130.`);
                spent += val;
            });
            if (spent !== totalCharPoints + coreRollValue) errors.push(`Total must be ${totalCharPoints + coreRollValue}.`);
            if (errors.length) return alert(errors.join('\n'));
            inputs.forEach(input => character.characteristics[input.id] = +input.value);
            nextStep(4);
        }

        function toggleDeduct() {
            const value = document.getElementById('age-select').value;
            ['age-deduct', 'age-18-21-deduct'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (value === '18-21') document.getElementById('age-18-21-deduct').classList.remove('hidden');
            else if (['40-49', '50-59', '60-69'].includes(value)) {
                document.getElementById('age-deduct').classList.remove('hidden');
                const deduct = {'40-49':10,'50-59':15,'60-69':20}[value];
                document.getElementById('required-deduct').textContent = deduct;
            }
        }

        function validateAgeDeduct() {
            const value = document.getElementById('age-select').value;
            let total = 0, deductStr = 0, deductCon = 0, deductDex = 0;
            if (value === '18-21') {
                deductStr = +document.getElementById('deduct-str-18-21').value || 0;
                deductCon = +document.getElementById('deduct-con-18-21').value || 0;
                deductDex = +document.getElementById('deduct-dex-18-21').value || 0;
                total = deductStr + deductCon + deductDex;
                document.getElementById('total-deduct-18-21').textContent = total;
            } else {
                deductStr = +document.getElementById('deduct-str').value || 0;
                deductCon = +document.getElementById('deduct-con').value || 0;
                deductDex = +document.getElementById('deduct-dex').value || 0;
                total = deductStr + deductCon + deductDex;
                document.getElementById('total-deduct').textContent = total;
            }
        }

        function applyAge() {
            const value = document.getElementById('age-select').value;
            character.age = value;
            const deductMap = {'18-21':5, '40-49':10, '50-59':15, '60-69':20};
            let deduct = deductMap[value] || 0;
            let strD = 0, conD = 0, dexD = 0;
            if (deduct) {
                const prefix = value === '18-21' ? '-18-21' : '';
                strD = +document.getElementById(`deduct-str${prefix}`).value || 0;
                conD = +document.getElementById(`deduct-con${prefix}`).value || 0;
                dexD = +document.getElementById(`deduct-dex${prefix}`).value || 0;
                if (strD + conD + dexD !== deduct) return alert(`Distribute exactly ${deduct} points.`);
            }
            character.characteristics.STR -= strD;
            character.characteristics.CON -= conD;
            character.characteristics.DEX -= dexD;
            const eduMods = {'22-39':10, '40-49':20, '50-59':30, '60-69':40};
            const appMods = {'40-49':-10, '50-59':-15, '60-69':-20};
            character.characteristics.EDU += eduMods[value] || 0;
            character.characteristics.APP += appMods[value] || 0;
            nextStep(5);
        }

        function rollLuck() {
            const d6a = Math.floor(Math.random() * 6) + 1;
            const d6b = Math.floor(Math.random() * 6) + 1;
            character.luck = 30 + (d6a + d6b) * 5;
            if (character.age === '18-21' && character.luck > 90) character.luck = 90;
            document.getElementById('luck-display').textContent = character.luck + (character.age === '18-21' && character.luck === 90 ? ' (Capped)' : '');
        }

        function calcSecondaries() {
            if (!character.luck) return alert('Roll Luck first.');
            let move = 7;
            const {DEX, STR, SIZ} = character.characteristics;
            if (DEX > STR && DEX > SIZ) move = 8;
            else if (Math.max(STR, SIZ) > DEX) move = 6;
            if (DEX > 90) move += 1;
            if (STR > 90) move -= 1;
            const ageMods = {'50-59':-1, '60-69':-2};
            move += ageMods[character.age] || 0;
            character.characteristics.Move = move;
            character.characteristics.HP = Math.ceil((character.characteristics.CON + SIZ) / 10);
            character.characteristics.Sanity = character.characteristics.POW;
            character.characteristics.MP = Math.floor(character.characteristics.POW / 5);
            const build = STR + SIZ;
            character.characteristics.Build = build < 65 ? -2 : build < 85 ? -1 : build < 125 ? 0 : build < 165 ? 1 : build < 205 ? 2 : 3;
            
            // Set initial dodge value on the skills object, to be used as a base in the next step
            character.skills.Dodge = Math.floor(DEX / 2);
            
            document.getElementById('secondary-display').innerHTML = `
                <p><strong>Move:</strong> ${move}</p>
                <p><strong>Hit Points:</strong> ${character.characteristics.HP}</p>
                <p><strong>Magic Points:</strong> ${character.characteristics.MP}</p>
                <p><strong>Sanity:</strong> ${character.characteristics.Sanity}</p>
                <p><strong>Build:</strong> ${character.characteristics.Build}</p>
                <p><strong>Dodge Base:</strong> ${character.skills.Dodge}%</p>
            `;
            nextStep(6);
        }

        function getSkillPoints() {
            const {skillPointsFormula} = character.occupation;
            const args = [character.characteristics.EDU, character.characteristics.DEX, character.characteristics.POW, character.characteristics.STR, character.characteristics.CON, character.characteristics.APP, character.characteristics.INT, character.characteristics.SIZ];
            const occPoints = skillPointsFormula(...args.slice(0, skillPointsFormula.length));
            return { occPoints, persPoints: character.characteristics.INT * 2, archPoints: 100 };
        }

        function isOccupationSkill(skillName) {
            const occSkills = character.occupation.skills;
            for (const occSkill of occSkills) {
                if (occSkill === skillName) return true;

                if (occSkill.endsWith('(any)')) {
                    const base = occSkill.replace(' (any)', '');
                    if (skillName.startsWith(base)) return true;
                }
                 if (occSkill.includes(' or ')) {
                    const options = occSkill.split(' or ').map(s => s.trim());
                    if (options.includes(skillName)) return true;
                }
                if (occSkill.includes('interpersonal')) {
                     if (['Charm', 'Fast Talk', 'Intimidate', 'Persuade'].includes(skillName)) return true;
                }
                 if (occSkill === 'Firearms (Rifle and Shotgun)') {
                    if (skillName === 'Firearms (Rifles)' || skillName === 'Firearms (Shotguns)') return true;
                }
                 if (occSkill === 'Firearms (Rifle/Shotgun or Handgun)') {
                    if (skillName === 'Firearms (Rifles)' || skillName === 'Firearms (Shotguns)' || skillName === 'Firearms (Handguns)') return true;
                }
                if (occSkill === 'Drive (Wagon)' && skillName === 'Drive Coach/Wagon') {
                    return true;
                }
            }
            return false;
        }


        function isArchetypeSkill(skillName) {
            const skills = character.archetype.bonusSkills;
            if (skills.includes(skillName)) return true;
            
            const anyChecks = {
                'Fighting (': 'Fighting (any)',
                'Firearms (': 'Firearms (any)',
                'Art/Craft': 'Art/Craft (any)',
                'Language Other': 'Language Other (any)'
            };

            for (const prefix in anyChecks) {
                if (skillName.startsWith(prefix) && skills.includes(anyChecks[prefix])) {
                    return true;
                }
            }
            return false;
        }

        function addSpecialtySkill(baseSkillName, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container not found for ID: ${containerId}`);
                return;
            }
            const skillData = ALL_SKILLS[baseSkillName];
            if (!skillData) return;
            
            specialtySkillCounter++;
            const newId = `${baseSkillName.replace(/[^a-zA-Z0-9]/g, '-')}-${specialtySkillCounter}`;

            const isOcc = isOccupationSkill(baseSkillName + ' (any)');
            const isArch = isArchetypeSkill(baseSkillName + ' (any)');

            const item = document.createElement('div');
            item.className = `skill-item specialty-item`;
            item.dataset.skillTemplate = baseSkillName;

            item.innerHTML = `
                <div class="skill-item-title">
                    ${baseSkillName} 
                    (<input type="text" class="specialty-input" placeholder="Specify..." oninput="recalculateSkillPoints()">)
                </div>
                <div class="skill-input-container">
                    <span>Base: ${skillData.base}%</span>
                    <input type="number" class="skill-input" value="${skillData.base}" min="${skillData.base}" data-base="${skillData.base}" data-skill-name="${newId}" oninput="recalculateSkillPoints()">
                </div>
                <div class="skill-labels">
                    ${isOcc ? '<span class="skill-label occupation-label">Occupational</span>' : ''}
                    ${isArch ? '<span class="skill-label archetype-label">Archetype Bonus</span>' : ''}
                </div>
            `;
            container.appendChild(item);
        }

        function calculateAndDisplaySkillPoints() {
            const { occPoints, persPoints } = getSkillPoints();
            document.getElementById('occ-total').textContent = occPoints;
            document.getElementById('pers-total').textContent = persPoints;
            
            const skillAllocDiv = document.getElementById('skill-alloc');
            const selectedOccupationName = document.getElementById('occupation-select').value;
            const minCR = character.occupation.crRange[0];
            skillAllocDiv.innerHTML = `<p class="subtitle" style="font-weight:bold; color: var(--glow-yellow);">Reminder: Your occupation (${selectedOccupationName}) requires a minimum Credit Rating of ${minCR}.</p>`;

            ALL_SKILLS.Dodge.base = Math.floor(character.characteristics.DEX / 2);
            ALL_SKILLS['Language Own'].base = character.characteristics.EDU;

            for (const category in SKILL_CATEGORIES) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'skill-category';
                categoryDiv.innerHTML = `<h3>${category}</h3>`;
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'skill-grid';

                SKILL_CATEGORIES[category].forEach(skillName => {
                    const skillData = ALL_SKILLS[skillName];
                    if (!skillData) return;
                    
                    if (skillData.isSpecialty) {
                        const specialtyContainerId = `${skillName.replace(/[^a-zA-Z0-9]/g, '-')}-specialties`;
                        const specialtyDiv = document.createElement('div');
                        specialtyDiv.innerHTML = `
                            <button onclick="addSpecialtySkill('${skillName}', '${specialtyContainerId}')">+ Add ${skillName} Specialty</button>
                            <div id="${specialtyContainerId}" class="skill-grid" style="grid-template-columns: 1fr; margin-top: 5px;"></div>
                        `;
                        gridDiv.appendChild(specialtyDiv);
                    } else {
                        const base = skillData.base;
                        const isOcc = isOccupationSkill(skillName);
                        const isArch = isArchetypeSkill(skillName);
                        const item = document.createElement('div');
                        item.className = `skill-item`;
                        item.innerHTML = `
                            <div class="skill-item-title">${skillName}</div>
                            <div class="skill-input-container">
                                <span>Base: ${base}%</span>
                                <input type="number" class="skill-input" value="${base}" min="${base}" data-base="${base}" data-skill-name="${skillName}" oninput="recalculateSkillPoints()">
                            </div>
                            <div class="skill-labels">
                                ${isOcc ? '<span class="skill-label occupation-label">Occupational</span>' : ''}
                                ${isArch ? '<span class="skill-label archetype-label">Archetype Bonus</span>' : ''}
                            </div>
                        `;
                        gridDiv.appendChild(item);
                    }
                });
                categoryDiv.appendChild(gridDiv);
                skillAllocDiv.appendChild(categoryDiv);
            }
             
            addSpecialtySkill('Art/Craft', 'Art-Craft-specialties');
            const tinkeringItem = document.querySelector('.specialty-item[data-skill-template="Art/Craft"]:last-child');
            if(tinkeringItem) {
                tinkeringItem.querySelector('.specialty-input').value = 'Tinkering';
            }


            recalculateSkillPoints();
        }

        function recalculateSkillPoints() {
            const { occPoints, persPoints, archPoints } = getSkillPoints();
            let archSpent = 0;
            let occSpent = 0;
            let persSpent = 0;
            
            document.querySelectorAll('.skill-input').forEach(input => {
                let skillName = input.dataset.skillName;
                const parentItem = input.closest('.skill-item');
                let isArch, isOcc;

                if (parentItem.classList.contains('specialty-item')) {
                    const templateName = parentItem.dataset.skillTemplate;
                    isArch = isArchetypeSkill(templateName + ' (any)');
                    isOcc = isOccupationSkill(templateName + ' (any)');
                } else {
                    isArch = isArchetypeSkill(skillName);
                    isOcc = isOccupationSkill(skillName);
                }

                const base = parseInt(input.dataset.base, 10);
                const value = parseInt(input.value, 10);
                
                if (isNaN(value) || value < base) return;

                let pointsAdded = value - base;
                
                if (isArch) {
                    const fromArch = Math.min(pointsAdded, archPoints - archSpent);
                    archSpent += fromArch;
                    pointsAdded -= fromArch;
                }
                
                if (isOcc || skillName === 'Credit Rating') {
                    const fromOcc = Math.min(pointsAdded, occPoints - occSpent);
                    occSpent += fromOcc;
                    pointsAdded -= fromOcc;
                }
                
                persSpent += pointsAdded;
            });
            
            const archRemSpan = document.getElementById('arch-rem');
            archRemSpan.textContent = archPoints - archSpent;
            archRemSpan.classList.toggle('overspent', archSpent > archPoints);

            const occRemSpan = document.getElementById('occ-rem');
            occRemSpan.textContent = occPoints - occSpent;
            occRemSpan.classList.toggle('overspent', occSpent > occPoints);

            const persRemSpan = document.getElementById('pers-rem');
            persRemSpan.textContent = persPoints - persSpent;
            persRemSpan.classList.toggle('overspent', persSpent > persPoints);

            document.getElementById('complete-skills-btn').disabled = (archSpent > archPoints || occSpent > occPoints || persSpent > persPoints);
        }

        function completeSkills() {
            const minCR = character.occupation.crRange[0];
            const crInput = document.querySelector('.skill-input[data-skill-name="Credit Rating"]');
            if(parseInt(crInput.value, 10) < minCR) {
                return alert(`You must allocate at least ${minCR} points to Credit Rating for a ${document.getElementById('occupation-select').value}.`);
            }
            
            character.skills = {};
            document.querySelectorAll('.skill-item').forEach(item => {
                const skillInput = item.querySelector('.skill-input');
                let skillName = skillInput.dataset.skillName;
                if (item.classList.contains('specialty-item')) {
                    const specialtyInput = item.querySelector('.specialty-input');
                    const specialty = specialtyInput.value.trim() || 'Unnamed';
                    const templateName = item.dataset.skillTemplate;
                    skillName = `${templateName} (${specialty})`;
                }
                character.skills[skillName] = +skillInput.value || 0;
            });

            nextStep(7);
        }

        function populateHindSelect() {
            const div = document.getElementById('hindrance-checkboxes');
            div.innerHTML = Object.entries(HINDRANCES).map(([key, data]) => `
                <div class="hindrance-item">
                    <div class="hindrance-header" onclick="toggleDescription(this)">
                        <input type="checkbox" value="${key}" onclick="event.stopPropagation(); updateSelectedHindrances()">
                        <span class="hindrance-name">${key}</span>
                    </div>
                    <div class="hindrance-description hidden">${data.desc}</div>
                </div>
            `).join('');
        }

        function populateTalSelect() {
            const div = document.getElementById('talent-checkboxes');
            div.innerHTML = Object.entries(TALENTS).map(([key, data]) => `
                <div class="talent-item">
                     <div class="talent-header" onclick="toggleDescription(this)">
                        <input type="checkbox" value="${key}" onclick="event.stopPropagation(); updateSelectedTalents()">
                        <span class="talent-name">${key}</span>
                    </div>
                    <div class="talent-description hidden">${data.desc}</div>
                </div>
            `).join('');
        }

        function toggleDescription(headerEl) {
            const parentItem = headerEl.parentElement;
            const description = parentItem.querySelector('.hindrance-description, .talent-description');
            if(description) {
                description.classList.toggle('hidden');
            }
        }

        function updateSelectedHindrances() {
            const checked = [...document.querySelectorAll('#hindrance-checkboxes input:checked')];
            character.hindrances = checked.map(cb => ({name: cb.value, value: HINDRANCES[cb.value].value}));
            document.getElementById('selected-hinds').textContent = character.hindrances.map(h => h.name.split(' (')[0]).join(', ') || 'None';
            document.getElementById('talent-points').textContent = character.hindrances.reduce((sum, h) => sum + h.value, 0);
        }

        function updateSelectedTalents() {
            const checked = [...document.querySelectorAll('#talent-checkboxes input:checked')];
            character.talents = checked.map(cb => ({name: cb.value, value: TALENTS[cb.value].value}));
            document.getElementById('selected-tals').textContent = character.talents.map(t => t.name.split(' (')[0]).join(', ') || 'None';
        }


        function rollNaturalTalent() {
            const allTalents = Object.entries(TALENTS);
            let rolledTalent = null;
            while (!rolledTalent) {
                const [name, data] = allTalents[Math.floor(Math.random() * allTalents.length)];
                if (data.value >= 1 && data.value <= 3) {
                    rolledTalent = { name, value: data.value };
                }
            }
            document.getElementById('natural-talent').textContent = `${rolledTalent.name} (Value: ${rolledTalent.value})`;
        }

        function completeHT() {
            nextStep(8);
        }

        function completeBackstory() {
            ['name', 'gender', 'description', 'ideology', 'significant-people', 'meaningful', 'traits', 'hair-eye', 'marks'].forEach(key => {
                character[key.replace(/-/g, '')] = document.getElementById(key).value;
            });
            character.madness = document.getElementById('madness').value;
            character.heritageText = document.getElementById('heritage').selectedOptions[0].text;
            nextStep(9);
        }

        function generateSheet() {
            const title = document.getElementById('sheet-title');
            const content = document.getElementById('sheet-content');
            title.textContent = character.name || 'Untitled Character';

            let skillsHtml = `<h3>Skills</h3><ul>
                <li><strong>Occupation Points Spent:</strong> ${document.getElementById('occ-total').textContent - parseInt(document.getElementById('occ-rem').textContent)}</li>
                <li><strong>Personal Points Spent:</strong> ${document.getElementById('pers-total').textContent - parseInt(document.getElementById('pers-rem').textContent)}</li>
                <li><strong>Archetype Bonus Spent:</strong> ${100 - parseInt(document.getElementById('arch-rem').textContent)}</li>
            </ul><hr><h3>Skill Values</h3><ul>`;
            
            Object.entries(character.skills).sort(([a], [b]) => a.localeCompare(b)).forEach(([skill, val]) => {
                // Determine the base skill to compare against for specialty skills
                let baseSkillName = skill;
                const specialtyMatch = skill.match(/^(.*?)\s\(.*\)$/);
                if (specialtyMatch) {
                    baseSkillName = specialtyMatch[1];
                }
                
                if (ALL_SKILLS[baseSkillName] && val > ALL_SKILLS[baseSkillName].base) {
                    skillsHtml += `<li><strong>${skill}:</strong> ${val}%</li>`;
                } else if (skill === 'Dodge' && val > 0) { // Only show dodge if points are spent
                     skillsHtml += `<li><strong>${skill}:</strong> ${val}%</li>`;
                }
            });

            skillsHtml += '</ul>';
            
            const archetypeTalentName = character.archetype ? character.archetype.talent : 'N/A';

            content.innerHTML = `
                <h3>Characteristics</h3>
                <ul>${charList.map(c => `<li><strong>${c}:</strong> ${character.characteristics[c] || 15}</li>`).join('')}</ul>
                <h3>Secondary Attributes</h3>
                <p><strong>Luck:</strong> ${character.luck}</p>
                 <p><strong>Move:</strong> ${character.characteristics.Move}</p>
                <p><strong>Hit Points:</strong> ${character.characteristics.HP}</p>
                <p><strong>Magic Points:</strong> ${character.characteristics.MP}</p>
                <p><strong>Sanity:</strong> ${character.characteristics.Sanity}</p>
                <p><strong>Build:</strong> ${character.characteristics.Build}</p>
                ${skillsHtml}
                <h3>Talents & Hindrances</h3>
                <p><strong>Archetype Talent:</strong> ${archetypeTalentName}</p>
                <p><strong>Natural Talent:</strong> ${document.getElementById('natural-talent').textContent}</p>
                <p><strong>Selected Talents:</strong> ${character.talents.map(t => t.name.split(' (')[0]).join(', ') || 'None'}</p>
                <p><strong>Selected Hindrances:</strong> ${character.hindrances.map(h => h.name.split(' (')[0]).join(', ') || 'None'}</p>
                <h3>Backstory</h3>
                <p><strong>Gender:</strong> ${character.gender}</p>
                <p><strong>Description:</strong> ${character.description}</p>
                <p><strong>Heritage:</strong> ${character.heritageText}</p>
                <p><strong>Ideology/Beliefs:</strong> ${character.ideology}</p>
                <p><strong>Significant People:</strong> ${character.significantpeople}</p>
                <p><strong>Meaningful Location/Possessions:</strong> ${character.meaningful}</p>
                <p><strong>Traits:</strong> ${character.traits}</p>
                <p><strong>Bout of Madness:</strong> ${character.madness}</p>
                <p><strong>Hair/Eye Color:</strong> ${character.haireye}</p>
                <p><strong>Distinguishing Marks:</strong> ${character.marks}</p>
            `;
            document.getElementById('character-sheet').classList.remove('hidden');
            document.getElementById('step9').classList.add('hidden');
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

