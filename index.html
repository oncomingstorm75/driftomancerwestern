<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Western RPG Charactermancer</title>
    <style>
        /* Your existing CSS remains unchanged */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Creepster&family=Rye&family=Merriweather:wght@400;700&display=swap');
        :root { --primary-bg: linear-gradient(135deg, #2c1a0e 0%, #4c301c 50%, #6e482a 100%); --section-bg: rgba(44, 26, 14, 0.7); --border-color: #5a3d2e; --accent-gold: #c98e2a; --text-light: #d8c29e; --text-dark: #4c301c; --bg-light: #f5f5dc; --glow-yellow: #ffeb3b; --glow-orange: #ff9800; --shadow-dark: rgba(0, 0, 0, 0.5); --shadow-gold: rgba(201, 142, 42, 0.5); --error-red: #e53e3e; }
        body { font-family: 'Cinzel', serif; background: var(--primary-bg); margin: 0; padding: 20px; min-height: 100vh; position: relative; overflow-x: hidden; color: var(--text-light); }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="parchment" width="100" height="100" patternUnits="userSpaceOnUse"><rect width="100" height="100" fill="%23f5f5dc"/><path fill="%23d4c3a1" d="M0 0h100v100h-100zM100 0L0 100l100 100V0z"/></pattern></defs><rect width="100" height="100" fill="url(%23parchment)"/></svg>') repeat; opacity: 0.1; z-index: -1; }
        h1 { text-align: center; color: var(--accent-gold); text-shadow: 0 0 5px var(--glow-yellow), 0 0 10px var(--glow-orange); font-size: clamp(2em, 5vw, 3em); font-family: 'Creepster', cursive; margin-bottom: 10px; animation: glow 2s infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 5px var(--accent-gold), 0 0 10px var(--accent-gold); } to { text-shadow: 0 0 10px var(--glow-yellow), 0 0 20px var(--glow-orange); } }
        .subtitle { text-align: center; color: #F4A460; margin-bottom: 20px; font-style: italic; }
        section { background: var(--section-bg); border: 2px solid var(--border-color); border-radius: 10px; padding: 20px; margin: 20px auto; max-width: 800px; box-shadow: inset 0 0 15px var(--shadow-dark), 0 0 10px var(--shadow-gold); position: relative; }
        h2 { color: var(--text-light); text-align: center; text-shadow: 1px 1px 2px #000; border-bottom: 2px dashed var(--accent-gold); padding-bottom: 10px; font-size: 2em; margin-top: 0; }
        h3 { color: var(--text-light); border-bottom: 1px dashed var(--accent-gold); padding-bottom: 5px; }
        select, input, textarea, button { background: var(--bg-light); border: 1px solid #4c301c; border-radius: 5px; padding: 8px; margin: 5px; font-family: inherit; color: var(--text-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease; }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 5px var(--shadow-gold); }
        input.specialty-input { padding: 4px; margin-left: 5px; width: 100px; }
        textarea { resize: vertical; min-height: 60px; width: 100%; }
        button { background: linear-gradient(var(--accent-gold), #a3721e); color: var(--text-dark); cursor: pointer; font-weight: bold; text-transform: uppercase; border: none; }
        button:hover:not(:disabled) { background: linear-gradient(var(--glow-yellow), var(--accent-gold)); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none; }
        .roll-display { color: var(--glow-yellow); font-weight: bold; text-shadow: 1px 1px 2px #000; }
        .char-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .char-input-group label { flex: 1; font-weight: bold; }
        .char-input-group input { flex: 2; }
        .skill-category h3 { margin-top: 20px; font-family: 'Rye', cursive; font-size: 1.5em; }
        .skill-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; }
        .skill-item { border: 1px solid var(--border-color); padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 5px; position: relative; }
        .skill-item-title { font-weight: bold; color: #f5e7c8; font-size: 0.9em; display: flex; align-items: center; }
        .skill-input-container { display: flex; align-items: center; gap: 5px; font-size: 0.8em; margin-top: 5px; }
        .skill-labels { margin-top: 4px; display: flex; gap: 5px; flex-wrap: wrap; }
        .skill-label { font-size: 0.7em; padding: 2px 6px; border-radius: 8px; font-family: 'Merriweather', sans-serif; font-style: normal; font-weight: bold; color: var(--bg-light); }
        .occupation-label { background-color: #9d5d5d; }
        .archetype-label { background-color: #5d9d7b; }
        .skill-input { width: 50px; }
        .talent-grid, .hindrance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 10px; }
        .talent-item, .hindrance-item { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; border: 1px solid var(--border-color); }
        .talent-item:hover, .hindrance-item:hover { background: rgba(0,0,0,0.4); border-color: var(--accent-gold); }
        .talent-header, .hindrance-header { display: flex; align-items: center; width: 100%; cursor: pointer; }
        .talent-header input, .hindrance-header input { margin-right: 10px; cursor: pointer; }
        .talent-name, .hindrance-name { font-weight: bold; color: #f5e7c8; transition: color 0.2s; pointer-events: none; }
        .talent-description, .hindrance-description { font-size: 0.9em; color: var(--text-light); margin-top: 5px; padding-left: 10px; border-left: 2px solid var(--accent-gold); width: 100%; box-sizing: border-box; }
        .points-summary { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px 15px; }
        .points-summary p { margin: 0; font-weight: bold; }
        .points-summary .overspent { color: var(--error-red); text-shadow: 0 0 3px var(--error-red); }
        label { display: block; margin-bottom: 5px; }
        input[type="number"] { width: 60px; }
        ul { list-style-type: none; padding: 0; }
        ul li { margin-bottom: 5px; }
        #archetype-info, #occupation-info { background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); border-radius: 5px; padding: 15px; margin-top: 20px; }
        #archetype-info h4, #occupation-info h4 { color: var(--accent-gold); margin-top: 0; margin-bottom: 5px; }
        #archetype-info ul, #occupation-info ul { padding-left: 15px; list-style-type: disc; }
        #archetype-info p, #occupation-info p { margin-top: 0; }
        #occ-skill-choice-container { margin-bottom: 15px; padding: 10px; border: 1px dashed var(--accent-gold); border-radius: 5px; }
        #occ-skill-choice-container h4 { margin-top: 0; margin-bottom: 10px; }
        @media (max-width: 600px) { body { padding: 10px; } section { padding: 15px; } .skill-grid { grid-template-columns: 1fr; } .talent-grid, .hindrance-grid { grid-template-columns: 1fr; } .char-input-group { flex-direction: column; align-items: flex-start; } .points-summary { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    
    <h1>Western RPG Charactermancer</h1>
    <p class="subtitle">Made for Rollingdeadly's The Quick and the Dead</p>

    <section id="step1">
        <h2>Step 1: Choose your Western Archetype</h2>
        <select id="archetype-select" aria-label="Select your character's archetype" onchange="displayArchetypeInfo()"><option value="">Select an Archetype...</option></select>
        <div id="archetype-info" class="hidden"></div>
        <button onclick="selectArchetype()">Saddle Up - Next</button>
    </section>
    <section id="step2" class="hidden">
        <h2>Step 2: Choose your Occupation</h2>
        <select id="occupation-select" aria-label="Choose an occupation" onchange="displayOccupationInfo()"><option value="">Select an Occupation...</option></select>
        <div id="occupation-info" class="hidden"></div>
        <button onclick="selectOccupation()">Next</button>
        <button onclick="prevStep(1)">Back</button>
    </section>
    <section id="step3" class="hidden">
        <h2>Step 3: Generate Characteristics</h2>
        <p>Core Characteristic: <select id="core-char-select" aria-label="Select core characteristic" onchange="updateCharacteristicInputs()"></select></p>
        <p class="roll-display">Core Roll: <span id="core-roll-display">Not rolled yet</span></p>
        <button onclick="rollCore()">Roll Core</button>
        <p>Total points: 460 + Core. Allocate to: STR, CON, DEX, POW, APP, EDU, INT, SIZ (Min 15, Max 130)</p>
        <div id="char-alloc"></div>
        <p>Remaining Points: <span id="remaining-points">460</span></p>
        <button onclick="completeChars()">Next</button>
        <button onclick="prevStep(2)">Back</button>
    </section>
    <section id="step4" class="hidden">
        <h2>Step 4: Choose Age & Apply Modifiers</h2>
        <select id="age-select" onchange="toggleDeduct()" aria-label="Select age">
            <option value="18-21">18-21: Deduct 5 total among STR, SIZ, and EDU. Max Luck 90.</option>
            <option value="22-39">22-39: +10 EDU</option>
            <option value="40-49">40-49: +20 EDU, -10 APP, -10 total from STR, CON, or DEX</option>
            <option value="50-59">50-59: +30 EDU, -15 APP, -15 total from STR, CON, or DEX</option>
            <option value="60-69">60-69: +40 EDU, -20 APP, -20 total from STR, CON, or DEX</option>
        </select>
        <div id="age-deduct" class="hidden">
            <p>Distribute total deduction across STR, CON, DEX:</p>
            <label>STR: <input id="deduct-str" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <label>CON: <input id="deduct-con" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <label>DEX: <input id="deduct-dex" type="number" min="0" value="0" onchange="validateAgeDeduct()"></label>
            <p>Total Deducted: <span id="total-deduct">0</span>/<span id="required-deduct">0</span></p>
        </div>
        <div id="age-18-21-deduct" class="hidden">
            <p>Distribute 5 points to deduct from STR, SIZ, EDU:</p>
            <label>STR: <input id="deduct-str-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <label>SIZ: <input id="deduct-siz-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <label>EDU: <input id="deduct-edu-18-21" type="number" min="0" max="5" value="0" onchange="validateAgeDeduct()"></label>
            <p>Total Deducted: <span id="total-deduct-18-21">0</span>/5</p>
        </div>
        <button onclick="applyAge()">Apply & Next</button>
        <button onclick="prevStep(3)">Back</button>
    </section>
    <section id="step5" class="hidden">
        <h2>Step 5: Determine Secondary Attributes</h2>
        <button onclick="rollLuck()">Roll Luck</button>
        <p class="roll-display">Luck: <span id="luck-display">Not rolled yet</span></p>
        <button onclick="calcSecondaries()">Calculate All</button>
        <div id="secondary-display"></div>
        <button onclick="nextStep(6)">Next</button>
        <button onclick="prevStep(4)">Back</button>
    </section>
    <section id="step6" class="hidden">
        <h2>Step 6: Skill Points</h2>
        <p>Allocate your skill points. Points are spent from pools in this order: Archetype > Occupation > Personal.</p>
        <div class="points-summary">
            <p>Archetype Points: <span id="arch-rem">100</span> / 100</p>
            <p>Occupation Points: <span id="occ-rem">0</span> / <span id="occ-total">0</span></p>
            <p>Personal Points: <span id="pers-rem">0</span> / <span id="pers-total">0</span></p>
        </div>
        <hr>
        <div id="skill-alloc"></div>
        <button id="complete-skills-btn" onclick="completeSkills()">Next</button>
        <button onclick="prevStep(5)">Back</button>
    </section>
    <section id="step7" class="hidden">
        <h2>Step 7: Determine Hindrances and Talents</h2>
        <button onclick="rollNaturalTalent()">Roll Natural Talent</button>
        <p class="roll-display">Natural Talent: <span id="natural-talent">Not rolled yet</span></p>
        <p><strong>Archetype Talent:</strong> <span id="arch-talent"></span></p>
        <h3>Hindrances (Max 5 total, 1 major &gt; 3 points)</h3>
        <div id="hindrance-checkboxes" class="hindrance-grid"></div>
        <p>Hindrances: <span id="selected-hinds">None</span> | Talent Points: <span id="talent-points">0</span></p>
        <h3>Talents (Max 5 total incl. arch/natural, 1 major &gt; 3 points)</h3>
        <div id="talent-checkboxes" class="talent-grid"></div>
        <p>Talents: <span id="selected-tals">None</span></p>
        <button onclick="completeHT()">Next</button>
        <button onclick="prevStep(6)">Back</button>
    </section>
    <section id="step8" class="hidden">
        <h2>Step 8: Create Backstory</h2>
        <label for="name">Name: <input id="name" type="text"></label>
        <label for="gender">Gender: <input id="gender" type="text"></label>
        <label for="description">Personal Description: <textarea id="description"></textarea></label>
        <label for="heritage">Heritage:
            <select id="heritage">
                <option value="a">a. African American</option>
                <option value="b">b. Far East (Chinese, Japanese, etc.)</option>
                <option value="c">c. European (Irish American, Italian, German...)</option>
                <option value="d">d. Southern (Mexican, Cuban, etc.)</option>
                <option value="e">e. Mysterious (Thereâ€™s something odd about you...)</option>
            </select>
        </label>
        <label for="ideology">Ideology/Beliefs: <input id="ideology" type="text"></label>
        <label for="significant-people">Significant People: <input id="significant-people" type="text"></label>
        <label for="meaningful">Meaningful Location/Possessions: <input id="meaningful" type="text"></label>
        <label for="traits">Traits: <input id="traits" type="text"></label>
        <label for="madness">Bout of Madness: <textarea id="madness"></textarea></label>
        <label for="hair-eye">Hair/Eye Color: <input id="hair-eye" type="text"></label>
        <label for="marks">Distinguishing Marks: <input id="marks" type="text"></label>
        <button onclick="completeBackstory()">Next</button>
        <button onclick="prevStep(7)">Back</button>
    </section>
    <section id="step9" class="hidden">
        <h2>Step 9: Finalize Character</h2>
        <button onclick="generateAndDownloadJSON()">Download Character JSON</button>
        <button onclick="prevStep(8)">Back</button>
    </section>
    
    <script>
        // All data constants (ARCHETYPES, HINDRANCES, etc.) are unchanged and included here...
        const ARCHETYPES = { /* UNCHANGED */ };
        const HINDRANCES = { /* UNCHANGED */ };
        const TALENTS = { /* UNCHANGED */ };
        const ALL_SKILLS = { /* UNCHANGED */ };
        const SKILL_CATEGORIES = { /* UNCHANGED */ };
        
        // --- THIS DATA OBJECT IS THE PRIMARY FIX ---
        const OCCUPATIONS = {
            'Artist': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.POW * 2), skillPointsText: "EDU x 2 + (DEX x 2 or POW x 2)", crRange: [6, 60], skills: ['Art/Craft (any)', 'History', 'Library Use', 'Psychology', 'Spot Hidden', 'Sleight of Hand', 'any two other skills as personal or era specialties'] },
            'Author': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [9, 30], skills: ['Art/Craft (Literature)', 'History', 'Library Use', 'Natural World or Occult', 'Language Other', 'Language Own', 'Psychology', 'any one other skill as a personal or era specialty'] },
            'Bartender': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.APP * 2, skillPointsText: "EDU x 2 + APP x 2", crRange: [8, 25], skills: ['Accounting', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Fighting (Brawling)', 'Listen', 'Psychology', 'Spot Hidden', 'any one other skill as a personal or era specialty'] },
            'Big Game Hunter': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [20, 50], skills: ['Firearms', 'Listen or Spot Hidden', 'Natural World', 'Navigate', 'Other Language or Survival (any)', 'Stealth', 'Track', 'Trap'] },
            'Bounty Hunter': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [9, 30], skills: ['Drive Coach/Wagon', 'Fighting or Firearms (any)', 'one interpersonal skill (Fast Talk, Charm, Intimidate, or Persuade)', 'Law', 'Psychology', 'Rope Use', 'Track', 'Trap', 'Stealth'] },
            'Butler': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [9, 40], skills: ['Accounting or Appraise', 'Art/Craft (any, e.g. Cook, Tailor, Barber)', 'First Aid', 'Listen', 'Language Other', 'Psychology', 'Spot Hidden', 'any two other skills as personal or era specialties'] },
            'Coachman/woman': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.DEX * 2, skillPointsText: "EDU x 2 + DEX x 2", crRange: [10, 40], skills: ['Drive Coach/Wagon', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Listen', 'Mechanical Repair', 'Navigate', 'Ride', 'Spot Hidden', 'any one other skill as a personal or era specialty'] },
            'Confidence Trickster': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.APP * 2, skillPointsText: "EDU x 2 + APP x 2", crRange: [10, 80], skills: ['Disguise', 'Listen', 'Psychology', 'Sleight of Hand', 'Spot Hidden', 'and two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)'] },
            'Cowboy/girl': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [9, 20], skills: ['Firearms (Handgun or Shotgun)', 'First Aid', 'Jump', 'Natural World', 'Ride', 'Rope Use', 'Track'] },
            'Craftsperson': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.DEX * 2, skillPointsText: "EDU x 2 + DEX x 2", crRange: [10, 70], skills: ['Accounting', 'Art/Craft (any)', 'Drive (Wagon)', 'Mechanical Repair', 'Persuade', 'any three other skills as personal or era specialties'] },
            'Dilettante': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'APP' ? chars.APP * 2 : chars.CON * 2), skillPointsText: "EDU x 2 + (APP x 2 or CON x 2)", crRange: [50, 99], skills: ['Art/Craft (any)', 'Listen', 'Language Other', 'Ride', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)', 'any three other skills as personal or era specialties'] },
            'Doctor': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [30, 80], skills: ['Accounting', 'First Aid', 'Medicine', 'Language Other', 'Psychology', 'Science', 'any one other skill as a personal or era specialty'] },
            'Entertainer': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.APP * 2, skillPointsText: "EDU x 2 + APP x 2", crRange: [9, 60], skills: ['Art/Craft (e.g. Actor, Singer, Comedian, Musician etc.)', 'Disguise', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Listen', 'Psychology', 'any two other skills as personal or era specialties'] },
            'Expressman/woman': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.CON * 2), skillPointsText: "EDU x 2 + (DEX x 2 or CON x 2)", crRange: [20, 60], skills: ['Accounting', 'Drive (Wagon or Stagecoach)', 'Fast Talk', 'Firearms (any)', 'Mechanical Repair', 'Natural World', 'Navigate', 'Ride'] },
            'Farmer': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'STR' ? chars.STR * 2 : chars.CON * 2), skillPointsText: "EDU x 2 + (STR x 2 or CON x 2)", crRange: [9, 50], skills: ['Art/Craft (Farming)', 'Firearms (Rifle and Shotgun)', 'Drive (Wagon)', 'First Aid', 'Jump', 'Mechanical Repair', 'Natural World', 'Ride', 'Rope Use'] },
            'Gambler': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'POW' ? chars.POW * 2 : chars.DEX * 2), skillPointsText: "EDU x 2 + (POW x 2 or DEX x 2)", crRange: [10, 60], skills: ['Accounting', 'Gambling', 'Listen', 'Psychology', 'Sleight of Hand', 'Spot Hidden', 'one interpersonal skill (Charm, Fast Talk, or Persuade)', 'and one other skill as a personal or era specialty'] },
            'Gentleman/lady': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.APP * 2, skillPointsText: "EDU x 2 + APP x 2", crRange: [40, 90], skills: ['Art/Craft (any)', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Firearms (Handguns)', 'Gambling', 'History', 'Language Other', 'Navigate', 'Ride'] },
            'Gunfighter': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.DEX * 2, skillPointsText: "EDU x 2 + DEX x 2", crRange: [9, 70], skills: ['Dodge', 'Fighting (Brawl)', 'Firearms (any)', 'Ride', 'Stealth', 'Spot Hidden', 'Track', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)'] },
            'Hired Muscle': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.STR * 2, skillPointsText: "EDU x 2 + STR x 2", crRange: [5, 30], skills: ['Dodge', 'Drive Coach/wagon', 'Fighting (any)', 'Firearms (handguns and shotguns)', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'Stealth', 'Spot Hidden'] },
            'Hobo': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'CON' ? chars.CON * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (CON x 2 or STR x 2)", crRange: [0, 6], skills: ['Climb', 'Fast Talk', 'Jump', 'Listen', 'Natural World', 'Navigate', 'Stealth', 'any one other 2 skills as a personal or era specialty'] },
            'Hooker': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.APP * 2, skillPointsText: "EDU x 2 + APP x 2", crRange: [5, 50], skills: ['Art/Craft (any)', 'Dodge', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'Sleight of hand', 'Stealth', 'any one other skill as a personal or era specialty'] },
            'Itinerant Worker': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [0, 10], skills: ['Art/Craft (any)', 'Climb', 'Sleight of Hand', 'Mechanical Repair', 'Natural World', 'Navigate', 'any two other skills as personal or era specialties'] },
            'Journalist': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.INT * 2, skillPointsText: "EDU x 2 + INT x 2", crRange: [9, 30], skills: ['Art/Craft (e.g. Writing, Photography, etc.)', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)', 'History', 'Library Use', 'Psychology', 'Spot Hidden', 'any two other skills as personal or era specialties'] },
            'Lawman/woman': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [20, 70], skills: ['Dodge', 'Fighting (Brawl)', 'Firearms (any)', 'Law', 'one interpersonal skill (Intimidate or Persuade)', 'Psychology', 'Ride', 'Spot Hidden', 'Track'] },
            'Lawyer/Judge': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [20, 80], skills: ['Accounting', 'Law', 'Library Use', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'any two other skills as personal or era specialties'] },
            'Librarian': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [9, 35], skills: ['Accounting', 'Library use', 'Language Other', 'Language Own', 'any four other skills as personal specialties or specialist reading topics'] },
            'Merchant': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'APP' ? chars.APP * 2 : chars.INT * 2), skillPointsText: "EDU x 2 + (APP x 2 or INT x 2)", crRange: [20, 60], skills: ['Accounting', 'Appraise', 'Psychology', 'Spot Hidden', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'any two other skills as personal or era specialties'] },
            'Miner/Prospector': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [5, 60], skills: ['Climb', 'First Aid', 'Mechanical Repair', 'Natural World', 'Navigate', 'Science', 'Spot Hidden', 'any one other skill as a personal or era specialty'] },
            'Nurse': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [9, 30], skills: ['First Aid', 'Listen', 'Medicine', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'Science', 'Spot Hidden'] },
            'Outlaw': { skillPointsFormula: (chars, choice) => { let statVal = 0; if (choice === 'APP') statVal = chars.APP * 2; else if (choice === 'DEX') statVal = chars.DEX * 2; else statVal = chars.INT * 2; return chars.EDU * 2 + statVal; }, skillPointsText: "EDU x 2 + (APP x 2 or DEX x 2 or INT x 2)", crRange: [6, 70], skills: ['Dodge', 'Fighting (any)', 'Firearms (any)', 'Ride', 'Stealth', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)', 'Locksmith or Mechanical Repair', 'Psychology or Sleight of Hand', 'Spot Hidden'] },
            'Person of God': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.APP * 2, skillPointsText: "EDU x 2 + APP x 2", crRange: [9, 60], skills: ['History', 'Library Use', 'Listen', 'Occult', 'Language Other', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'any one other skill as a personal or era specialty'] },
            'Politician': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'APP' ? chars.APP * 2 : chars.INT * 2), skillPointsText: "EDU x 2 + (APP x 2 or INT x 2)", crRange: [10, 99], skills: ['History', 'Law', 'Listen', 'Psychology', 'Charm', 'Persuade', 'any two other skills as personal or era specialties'] },
            'Pugilist': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.STR * 2, skillPointsText: "EDU x 2 + STR x 2", crRange: [9, 60], skills: ['Dodge', 'Fighting (Brawl)', 'Intimidate', 'Jump', 'Psychology', 'Spot Hidden', 'any two other skills as personal or era specialties'] },
            'Rancher': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'INT' ? chars.INT * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (INT x 2 or STR x 2)", crRange: [50, 99], skills: ['Accounting', 'Law', 'Natural World', 'Persuade', 'Ride', 'Rope Use', 'Spot Hidden', 'any one other skill as a personal or era specialty'] },
            'Sailor': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [9, 30], skills: ['Drive Coach/Wagon', 'Electrical or Mechanical Repair', 'Fighting (all)', 'Firearms (Rifles)', 'First Aid', 'Navigate', 'Rope Usen', 'Survival', 'Swim'] },
            'Student/Teacher': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [10, 50], skills: ['Library Use', 'Language Other', 'Persuade or Intimidate', 'Psychology', 'Science', 'any three other skills as professional or era specialties'] },
            'Scientist/Engineer': { skillPointsFormula: (chars) => chars.EDU * 4, skillPointsText: "EDU x 4", crRange: [20, 80], skills: ['History', 'Law', 'Library Use', 'Mechanical Repair', 'Operate Heavy Machinery', 'any three other skills as professional specialties'] },
            'Scout/Mountains Person': { skillPointsFormula: (chars, choice) => { let statVal = 0; if (choice === 'DEX') statVal = chars.DEX * 2; else if (choice === 'STR') statVal = chars.STR * 2; else statVal = chars.CON * 2; return chars.EDU * 2 + statVal; }, skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2 or CON x 2)", crRange: [0, 20], skills: ['Fighting (any)', 'Firearms (any)', 'First Aid', 'Natural World', 'Navigate', 'Ride', 'Rope Use', 'Stealth', 'Track', 'Trap'] },
            'Soldier/Warrior': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [10, 70], skills: ['Climb', 'Dodge', 'Fighting (any)', 'Firearms (Any)', 'First Aid', 'Mechanical Repair or Natural World', 'Stealth', 'Throw', 'any one other skill as a personal or era specialty'] },
            'Spy': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'APP' ? chars.APP * 2 : chars.DEX * 2), skillPointsText: "EDU x 2 + (APP x 2 or DEX x 2)", crRange: [20, 60], skills: ['Art/Craft (Acting) or Disguise', 'Dodge', 'Firearms', 'Listen', 'Language Other', 'one interpersonal skill (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'Sleight of Hand', 'Stealth'] },
            'Tribe Member': { skillPointsFormula: (chars, choice) => chars.EDU * 2 + (choice === 'DEX' ? chars.DEX * 2 : chars.STR * 2), skillPointsText: "EDU x 2 + (DEX x 2 or STR x 2)", crRange: [0, 15], skills: ['Climb', 'Fighting (any)', 'Throw', 'Listen', 'Natural World', 'Occult', 'Spot Hidden', 'Swim', 'Survival'] },
            'Zealot': { skillPointsFormula: (chars) => chars.EDU * 2 + chars.POW * 2, skillPointsText: "EDU x 2 + POW x 2", crRange: [0, 30], skills: ['History', 'two interpersonal skills (Charm, Fast Talk, Intimidate, or Persuade)', 'Psychology', 'Stealth', 'and any three other skills as personal or era specialties'] },
        };

        // ... All other functions are unchanged, except for generateJsonData() at the end ...
        const charList = ['STR', 'CON', 'DEX', 'POW', 'APP', 'EDU', 'INT', 'SIZ'];
        let character = { archetype: null, occupation: null, characteristics: {}, skills: {}, talents: [], hindrances: [], age: null, luck: 0, heritageText: '' };
        let coreCharacteristic = null; let coreRollValue = 0; const totalCharPoints = 460; let specialtySkillCounter = 0;
        function init() { populateSelect('archetype-select', Object.keys(ARCHETYPES)); }
        function populateSelect(id, options) { const select = document.getElementById(id); select.innerHTML = `<option value="">Select...</option>`; options.forEach(opt => { const option = document.createElement('option'); option.value = opt; option.textContent = opt; select.appendChild(option); }); }
        function nextStep(step) { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(`step${step}`).classList.remove('hidden'); if (step === 6) calculateAndDisplaySkillPoints(); if (step === 7) { populateHindSelect(); populateTalSelect(); const arch = ARCHETYPES[document.getElementById('archetype-select').value]; document.getElementById('arch-talent').textContent = arch.talent; } }
        function prevStep(toStep) { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(`step${toStep}`).classList.remove('hidden'); }
        function displayArchetypeInfo() { const select = document.getElementById('archetype-select'); const infoDiv = document.getElementById('archetype-info'); const archetypeKey = select.value; if (!archetypeKey) { infoDiv.classList.add('hidden'); return; } const archetype = ARCHETYPES[archetypeKey]; infoDiv.innerHTML = `<h4>Core Characteristic(s):</h4><p>${archetype.core.join(', ')}</p><h4>Archetype Talent: ${archetype.talent}</h4><p>${archetype.talentDesc}</p><h4>Bonus Archetype Skills:</h4><ul>${archetype.bonusSkills.map(skill => `<li>${skill}</li>`).join('')}</ul><h4>Allowed Occupations:</h4><p>${archetype.occupations.join(', ')}</p>`; infoDiv.classList.remove('hidden'); }
        function displayOccupationInfo() { const select = document.getElementById('occupation-select'); const infoDiv = document.getElementById('occupation-info'); const occupationKey = select.value; if (!occupationKey) { infoDiv.classList.add('hidden'); return; } const occupation = OCCUPATIONS[occupationKey]; infoDiv.innerHTML = `<h4>Skill Point Calculation:</h4><p>${occupation.skillPointsText}</p><h4>Credit Rating Range:</h4><p>${occupation.crRange[0]} - ${occupation.crRange[1]}</p><h4>Occupation Skills:</h4><ul>${occupation.skills.map(skill => `<li>${skill}</li>`).join('')}</ul>`; infoDiv.classList.remove('hidden'); }
        function selectArchetype() { const value = document.getElementById('archetype-select').value; if (!value) return alert("Please select an Archetype."); character.archetype = ARCHETYPES[value]; populateSelect('occupation-select', character.archetype.occupations); updateCoreCharSelect(); document.getElementById('occupation-info').classList.add('hidden'); document.getElementById('occupation-select').value = ''; nextStep(2); }
        function selectOccupation() { const value = document.getElementById('occupation-select').value; if (!value) return alert("Please select an Occupation."); character.occupation = OCCUPATIONS[value]; nextStep(3); }
        function updateCoreCharSelect() { populateSelect('core-char-select', character.archetype.core); updateCharacteristicInputs(); }
        function rollCore() { const value = document.getElementById('core-char-select').value; if (!value) return alert("Please select a core characteristic first."); updateCharacteristicInputs(); coreCharacteristic = value; const d6 = Math.floor(Math.random() * 6) + 1; coreRollValue = 65 + d6 * 5; document.getElementById('core-roll-display').textContent = coreRollValue; const input = document.getElementById(value); input.value = coreRollValue; input.min = coreRollValue; updateRemainingPoints(); }
        function updateCharacteristicInputs() { const div = document.getElementById('char-alloc'); div.innerHTML = ''; charList.forEach(char => { const group = document.createElement('div'); group.className = 'char-input-group'; group.innerHTML = `<label for="${char}">${char}:</label><input type="number" id="${char}" value="15" min="15" max="130" oninput="updateRemainingPoints()">`; div.appendChild(group); }); document.getElementById('core-roll-display').textContent = 'Not rolled yet'; coreCharacteristic = null; coreRollValue = 0; updateRemainingPoints(); }
        function updateRemainingPoints() { let spent = 0; document.querySelectorAll('#char-alloc input[type="number"]').forEach(i => spent += +i.value || 0); document.getElementById('remaining-points').textContent = totalCharPoints + coreRollValue - spent; }
        function completeChars() { if (!coreCharacteristic || !coreRollValue) return alert("Please roll for a core characteristic first."); const inputs = [...document.querySelectorAll('#char-alloc input[type="number"]')]; let spent = 0, errors = []; inputs.forEach(input => { const val = +input.value; if (isNaN(val) || val < +input.min || val > 130) errors.push(`${input.id} must be ${input.min}-130.`); spent += val; }); if (spent !== totalCharPoints + coreRollValue) errors.push(`Total must be ${totalCharPoints + coreRollValue}.`); if (errors.length) return alert(errors.join('\n')); inputs.forEach(input => character.characteristics[input.id] = +input.value); nextStep(4); }
        function toggleDeduct() { const value = document.getElementById('age-select').value; ['age-deduct', 'age-18-21-deduct'].forEach(id => document.getElementById(id).classList.add('hidden')); if (value === '18-21') { document.getElementById('age-18-21-deduct').classList.remove('hidden'); } else if (['40-49', '50-59', '60-69'].includes(value)) { document.getElementById('age-deduct').classList.remove('hidden'); const deduct = {'40-49':10,'50-59':15,'60-69':20}[value]; document.getElementById('required-deduct').textContent = deduct; } }
        function validateAgeDeduct() { const value = document.getElementById('age-select').value; let total = 0; if (value === '18-21') { const deductStr = +document.getElementById('deduct-str-18-21').value || 0; const deductSiz = +document.getElementById('deduct-siz-18-21').value || 0; const deductEdu = +document.getElementById('deduct-edu-18-21').value || 0; total = deductStr + deductSiz + deductEdu; document.getElementById('total-deduct-18-21').textContent = total; } else { const deductStr = +document.getElementById('deduct-str').value || 0; const deductCon = +document.getElementById('deduct-con').value || 0; const deductDex = +document.getElementById('deduct-dex').value || 0; total = deductStr + deductCon + deductDex; document.getElementById('total-deduct').textContent = total; } }
        function applyAge() { const value = document.getElementById('age-select').value; character.age = value; const deductMap = {'18-21': 5, '40-49': 10, '50-59': 15, '60-69': 20}; let deduct = deductMap[value] || 0; if (value === '18-21') { const strD = +document.getElementById('deduct-str-18-21').value || 0; const sizD = +document.getElementById('deduct-siz-18-21').value || 0; const eduD = +document.getElementById('deduct-edu-18-21').value || 0; if (strD + sizD + eduD !== deduct) return alert(`Distribute exactly 5 points.`); character.characteristics.STR -= strD; character.characteristics.SIZ -= sizD; character.characteristics.EDU -= eduD; } else if (deduct) { const strD = +document.getElementById('deduct-str').value || 0; const conD = +document.getElementById('deduct-con').value || 0; const dexD = +document.getElementById('deduct-dex').value || 0; if (strD + conD + dexD !== deduct) return alert(`Distribute exactly ${deduct} points.`); character.characteristics.STR -= strD; character.characteristics.CON -= conD; character.characteristics.DEX -= dexD; } const eduMods = {'22-39':10, '40-49':20, '50-59':30, '60-69':40}; const appMods = {'40-49':-10, '50-59':-15, '60-69':-20}; character.characteristics.EDU += eduMods[value] || 0; character.characteristics.APP += appMods[value] || 0; nextStep(5); }
        function rollLuck() { const d6a = Math.floor(Math.random() * 6) + 1; const d6b = Math.floor(Math.random() * 6) + 1; character.luck = 30 + (d6a + d6b) * 5; if (character.age === '18-21') character.luck = 90; document.getElementById('luck-display').textContent = character.luck + (character.age === '18-21' ? ' (Capped at 90)' : ''); }
        function calcSecondaries() { if (!character.luck) return alert('Roll Luck first.'); const {DEX, STR, SIZ, CON, POW} = character.characteristics; let move = 7; if (DEX < SIZ && STR < SIZ) { move = 7; } else if (DEX > SIZ && STR > SIZ) { move = 9; } else { move = 8; } character.characteristics.Move = move; character.characteristics.HP = Math.floor((CON + SIZ) / 10); character.characteristics.Sanity = POW; character.characteristics.MP = Math.floor(POW / 5); const strSiz = STR + SIZ; if (strSiz <= 64) { character.characteristics.Build = -2; } else if (strSiz <= 84) { character.characteristics.Build = -1; } else if (strSiz <= 124) { character.characteristics.Build = 0; } else if (strSiz <= 164) { character.characteristics.Build = 1; } else if (strSiz <= 204) { character.characteristics.Build = 2; } else if (strSiz <= 284) { character.characteristics.Build = 3; } else if (strSiz <= 364) { character.characteristics.Build = 4; } else { character.characteristics.Build = 5; } character.skills.Dodge = Math.floor(DEX / 2); document.getElementById('secondary-display').innerHTML = `<p><strong>Move:</strong> ${character.characteristics.Move}</p><p><strong>Hit Points:</strong> ${character.characteristics.HP}</p><p><strong>Magic Points:</strong> ${character.characteristics.MP}</p><p><strong>Sanity:</strong> ${character.characteristics.Sanity}</p><p><strong>Build:</strong> ${character.characteristics.Build}</p><p><strong>Dodge Base:</strong> ${character.skills.Dodge}%</p>`; nextStep(6); }
        function getSkillPoints() { const { skillPointsFormula } = character.occupation; let choice = null; const choiceRadio = document.querySelector('input[name="occ-skill-choice"]:checked'); if (choiceRadio) { choice = choiceRadio.value; } const occPoints = skillPointsFormula(character.characteristics, choice); return { occPoints, persPoints: character.characteristics.INT * 2, archPoints: 100 }; }
        function isOccupationSkill(skillName) { const occSkills = character.occupation.skills; for (const occSkill of occSkills) { if (occSkill === skillName) return true; if (occSkill.endsWith('(any)')) { const base = occSkill.replace(' (any)', ''); if (skillName.startsWith(base)) return true; } if (occSkill.includes(' or ')) { const options = occSkill.split(' or ').map(s => s.trim()); if (options.includes(skillName) || options.some(opt => skillName.startsWith(opt.replace('(any)','')))) return true; } if (occSkill.includes('interpersonal')) { if (['Charm', 'Fast Talk', 'Intimidate', 'Persuade'].includes(skillName)) return true; } if (occSkill === 'Firearms (Rifle and Shotgun)') { if (skillName === 'Firearms (Rifles)' || skillName === 'Firearms (Shotguns)') return true; } if (occSkill === 'Firearms (Rifle/Shotgun or Handgun)') { if (['Firearms (Rifles)', 'Firearms (Shotguns)', 'Firearms (Handguns)'].includes(skillName)) return true; } if (occSkill === 'Drive (Wagon)' && skillName === 'Drive Coach/Wagon') return true; } return false; }
        function isArchetypeSkill(skillName) { const skills = character.archetype.bonusSkills; if (skills.includes(skillName)) return true; const anyChecks = {'Fighting (': 'Fighting (any)','Firearms (': 'Firearms (any)','Art/Craft': 'Art/Craft (any)','Language Other': 'Language Other (any)'}; for (const prefix in anyChecks) { if (skillName.startsWith(prefix) && skills.includes(anyChecks[prefix])) { return true; } } return false; }
        function addSpecialtySkill(baseSkillName, containerId) { const container = document.getElementById(containerId); if (!container) return; const skillData = ALL_SKILLS[baseSkillName]; if (!skillData) return; specialtySkillCounter++; const newId = `${baseSkillName.replace(/[^a-zA-Z0-9]/g, '-')}-${specialtySkillCounter}`; const isOcc = isOccupationSkill(baseSkillName + ' (any)'); const isArch = isArchetypeSkill(baseSkillName + ' (any)'); const item = document.createElement('div'); item.className = `skill-item specialty-item`; item.dataset.skillTemplate = baseSkillName; item.innerHTML = `<div class="skill-item-title">${baseSkillName} (<input type="text" class="specialty-input" placeholder="Specify..." oninput="recalculateSkillPoints()">)</div><div class="skill-input-container"><span>Base: ${skillData.base}%</span><input type="number" class="skill-input" value="${skillData.base}" min="${skillData.base}" data-base="${skillData.base}" data-skill-name="${newId}" oninput="recalculateSkillPoints()"></div><div class="skill-labels">${isOcc ? '<span class="skill-label occupation-label">Occupational</span>' : ''}${isArch ? '<span class="skill-label archetype-label">Archetype Bonus</span>' : ''}</div>`; container.appendChild(item); }
        function updateSkillPointTotals() { const { occPoints, persPoints } = getSkillPoints(); document.getElementById('occ-total').textContent = occPoints; document.getElementById('pers-total').textContent = persPoints; recalculateSkillPoints(); }
        function calculateAndDisplaySkillPoints() { const skillAllocDiv = document.getElementById('skill-alloc'); const selectedOccupationName = document.getElementById('occupation-select').value; const minCR = character.occupation.crRange[0]; let headerHTML = `<p class="subtitle" style="font-weight:bold; color: var(--glow-yellow);">Reminder: Your occupation (${selectedOccupationName}) requires a minimum Credit Rating of ${minCR}.</p>`; const formulaText = character.occupation.skillPointsText; const choiceRegex = /\(([^)]+)\)/; const choiceMatch = formulaText.match(choiceRegex); if (choiceMatch && choiceMatch[1].includes(' or ')) { headerHTML += '<div id="occ-skill-choice-container"><h4>Choose Stat for Occupation Points:</h4>'; const options = choiceMatch[1].split(' or ').map(s => s.trim().split(' ')[0]); options.forEach((opt, index) => { const checked = index === 0 ? 'checked' : ''; headerHTML += `<label style="display: inline-block; margin-right: 15px;"><input type="radio" name="occ-skill-choice" value="${opt}" ${checked} onchange="updateSkillPointTotals()"> ${opt}</label>`; }); headerHTML += '</div>'; } skillAllocDiv.innerHTML = headerHTML; ALL_SKILLS.Dodge.base = Math.floor(character.characteristics.DEX / 2); ALL_SKILLS['Language Own'].base = character.characteristics.EDU; for (const category in SKILL_CATEGORIES) { const categoryDiv = document.createElement('div'); categoryDiv.className = 'skill-category'; categoryDiv.innerHTML = `<h3>${category}</h3>`; const gridDiv = document.createElement('div'); gridDiv.className = 'skill-grid'; SKILL_CATEGORIES[category].forEach(skillName => { const skillData = ALL_SKILLS[skillName]; if (!skillData) return; if (skillData.isSpecialty) { const specialtyContainerId = `${skillName.replace(/[^a-zA-Z0-9]/g, '-')}-specialties`; const specialtyDiv = document.createElement('div'); specialtyDiv.innerHTML = `<button onclick="addSpecialtySkill('${skillName}', '${specialtyContainerId}')">+ Add ${skillName} Specialty</button><div id="${specialtyContainerId}" class="skill-grid" style="grid-template-columns: 1fr; margin-top: 5px;"></div>`; gridDiv.appendChild(specialtyDiv); } else { const base = skillData.base; const isOcc = isOccupationSkill(skillName); const isArch = isArchetypeSkill(skillName); const item = document.createElement('div'); item.className = `skill-item`; item.innerHTML = `<div class="skill-item-title">${skillName}</div><div class="skill-input-container"><span>Base: ${base}%</span><input type="number" class="skill-input" value="${base}" min="${base}" data-base="${base}" data-skill-name="${skillName}" oninput="recalculateSkillPoints()"></div><div class="skill-labels">${isOcc ? '<span class="skill-label occupation-label">Occupational</span>' : ''}${isArch ? '<span class="skill-label archetype-label">Archetype Bonus</span>' : ''}</div>`; gridDiv.appendChild(item); } }); categoryDiv.appendChild(gridDiv); skillAllocDiv.appendChild(categoryDiv); } updateSkillPointTotals(); }
        function recalculateSkillPoints() { const { occPoints, persPoints, archPoints } = getSkillPoints(); let archSpent = 0, occSpent = 0, persSpent = 0; document.querySelectorAll('.skill-input').forEach(input => { let skillName = input.dataset.skillName; const parentItem = input.closest('.skill-item'); let isArch, isOcc; if (parentItem.classList.contains('specialty-item')) { const templateName = parentItem.dataset.skillTemplate; isArch = isArchetypeSkill(templateName + ' (any)'); isOcc = isOccupationSkill(templateName + ' (any)'); } else { isArch = isArchetypeSkill(skillName); isOcc = isOccupationSkill(skillName); } const base = parseInt(input.dataset.base, 10); const value = parseInt(input.value, 10); if (isNaN(value) || value < base) return; let pointsAdded = value - base; if (isArch) { const fromArch = Math.min(pointsAdded, archPoints - archSpent); archSpent += fromArch; pointsAdded -= fromArch; } if (isOcc || skillName === 'Credit Rating') { const fromOcc = Math.min(pointsAdded, occPoints - occSpent); occSpent += fromOcc; pointsAdded -= fromOcc; } persSpent += pointsAdded; }); const archRemSpan = document.getElementById('arch-rem'); archRemSpan.textContent = archPoints - archSpent; archRemSpan.classList.toggle('overspent', archSpent > archPoints); const occRemSpan = document.getElementById('occ-rem'); occRemSpan.textContent = occPoints - occSpent; occRemSpan.classList.toggle('overspent', occSpent > occPoints); const persRemSpan = document.getElementById('pers-rem'); persRemSpan.textContent = persPoints - persSpent; persRemSpan.classList.toggle('overspent', persSpent > persPoints); document.getElementById('complete-skills-btn').disabled = (archSpent > archPoints || occSpent > occPoints || persSpent > persPoints); }
        function completeSkills() { const minCR = character.occupation.crRange[0]; const crInput = document.querySelector('.skill-input[data-skill-name="Credit Rating"]'); if(parseInt(crInput.value, 10) < minCR) { return alert(`You must allocate at least ${minCR} points to Credit Rating for a ${document.getElementById('occupation-select').value}.`); } character.skills = {}; document.querySelectorAll('.skill-item').forEach(item => { const skillInput = item.querySelector('.skill-input'); let skillName = skillInput.dataset.skillName; if (item.classList.contains('specialty-item')) { const specialtyInput = item.querySelector('.specialty-input'); const specialty = specialtyInput.value.trim() || 'Unnamed'; const templateName = item.dataset.skillTemplate; skillName = `${templateName} (${specialty})`; } character.skills[skillName] = +skillInput.value || 0; }); nextStep(7); }
        function populateHindSelect() { const div = document.getElementById('hindrance-checkboxes'); div.innerHTML = Object.entries(HINDRANCES).map(([key, data]) => `<div class="hindrance-item"><div class="hindrance-header" onclick="toggleDescription(this)"><input type="checkbox" value="${key}" onclick="event.stopPropagation(); updateSelectedHindrances()"><span class="hindrance-name">${key}</span></div><div class="hindrance-description hidden">${data.desc}</div></div>`).join(''); }
        function populateTalSelect() { const div = document.getElementById('talent-checkboxes'); div.innerHTML = Object.entries(TALENTS).map(([key, data]) => `<div class="talent-item"><div class="talent-header" onclick="toggleDescription(this)"><input type="checkbox" value="${key}" onclick="event.stopPropagation(); updateSelectedTalents()"><span class="talent-name">${key}</span></div><div class="talent-description hidden">${data.desc}</div></div>`).join(''); }
        function toggleDescription(headerEl) { const parentItem = headerEl.parentElement; const description = parentItem.querySelector('.hindrance-description, .talent-description'); if(description) { description.classList.toggle('hidden'); } }
        function updateSelectedHindrances() { const checked = [...document.querySelectorAll('#hindrance-checkboxes input:checked')]; character.hindrances = checked.map(cb => ({name: cb.value, value: HINDRANCES[cb.value].value, desc: HINDRANCES[cb.value].desc})); document.getElementById('selected-hinds').textContent = character.hindrances.map(h => h.name.split(' (')[0]).join(', ') || 'None'; document.getElementById('talent-points').textContent = character.hindrances.reduce((sum, h) => sum + h.value, 0); }
        function updateSelectedTalents() { const checked = [...document.querySelectorAll('#talent-checkboxes input:checked')]; character.talents = checked.map(cb => ({name: cb.value, value: TALENTS[cb.value].value, desc: TALENTS[cb.value].desc})); document.getElementById('selected-tals').textContent = character.talents.map(t => t.name.split(' (')[0]).join(', ') || 'None'; }
        function rollNaturalTalent() { const allTalents = Object.entries(TALENTS); let rolledTalent = null; while (!rolledTalent) { const [name, data] = allTalents[Math.floor(Math.random() * allTalents.length)]; if (data.value >= 1 && data.value <= 3) { rolledTalent = { name, value: data.value, desc: data.desc }; } } character.naturalTalent = rolledTalent; document.getElementById('natural-talent').textContent = `${rolledTalent.name} (Value: ${rolledTalent.value})`; }
        function completeHT() { nextStep(8); }
        function completeBackstory() { ['name', 'gender', 'description', 'ideology', 'significant-people', 'meaningful', 'traits', 'hair-eye', 'marks'].forEach(key => { character[key.replace(/-/g, '')] = document.getElementById(key).value; }); character.madness = document.getElementById('madness').value; character.heritageText = document.getElementById('heritage').selectedOptions[0].text; nextStep(9); }
        
        function generateAndDownloadJSON() {
            const jsonData = generateJsonData();
            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const charName = character.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'character';
            a.download = `${charName}_sheet.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- FINAL, CORRECTED FUNCTION ---
        function generateJsonData() {
            const { characteristics, skills } = character;
            const ageString = character.age || "0";
            const ageNum = parseInt(ageString.split('-')[0], 10);

            const coreSkillAttributes = [
                'accounting', 'animal_handling', 'anthropology', 'appraise', 'archaeology', 'brawl',
                'charm', 'climb', 'credit_rating', 'demolitions', 'disguise', 'dodge', 'drive_auto',
                'electrical_repair', 'fast_talk', 'first_aid', 'handgun', 'history', 'intimidate',
                'jump', 'law', 'library_use', 'listen', 'locksmith', 'mechanical_repair', 'medicine',
                'natural_world', 'navigate', 'occult', 'operate_heavy_machinery', 'persuade', 'own',
                'psychology', 'read_lips', 'ride', 'sleight_of_hand', 'spot_hidden', 'stealth',
                'swim', 'throw', 'track'
            ];

            const psychicSkills = ['Medium', 'Telekinesis', 'Shamanic Magic', 'Witchcraft'];

            const skillMap = {
                'Fighting (Brawling)': 'brawl',
                'Firearms (Handguns)': 'handgun',
                'Drive Coach/Wagon': 'drive_auto',
                'Language Own': 'own'
            };
            
            let data = {
                "name": character.name || "",
                "occupation": document.getElementById('occupation-select').value || "",
                "archetype": document.getElementById('archetype-select').value || "",
                "gender": character.gender || "", 
                "age": ageNum,
                "strength": characteristics.STR || 0, "constitution": characteristics.CON || 0, "size": characteristics.SIZ || 0,
                "dexterity": characteristics.DEX || 0, "appearance": characteristics.APP || 0, "intelligence": characteristics.INT || 0,
                "power": characteristics.POW || 0, "education": characteristics.EDU || 0, "luck": character.luck || 0,
                "personal_description_value": character.description || "",
                "ideology_beliefs_value": character.ideology || "",
                "significant_people_value": character.significantpeople || "",
                "phobias_manias_value": character.madness || "",
                "repeating_talents": [], "repeating_additionalskills": [], "repeating_artcraft": [],
                "repeating_languages": [], "repeating_psychic": [],
                "bio": "", "gmnotes": ""
            };
            
            for (const skillName in skills) {
                const skillValue = skills[skillName];
                let handled = false;

                const mappedName = skillMap[skillName];
                if (mappedName && coreSkillAttributes.includes(mappedName)) {
                    data[mappedName] = skillValue;
                    handled = true;
                }

                if (!handled) {
                    const simpleName = skillName.toLowerCase().replace(/ /g, '_');
                    if (coreSkillAttributes.includes(simpleName)) {
                        data[simpleName] = skillValue;
                        handled = true;
                    }
                }
                
                if (!handled && psychicSkills.includes(skillName)) {
                    data.repeating_psychic.push({ name: skillName, value: skillValue });
                    handled = true;
                }

                if (!handled) {
                    const match = skillName.match(/^(.*?)\s\((.*)\)$/);
                    if (match) {
                        const base = match[1];
                        const specialty = match[2];
                        if (base === 'Art/Craft') {
                            data.repeating_artcraft.push({ name: specialty, value: skillValue });
                        } else if (base === 'Language Other') {
                            data.repeating_languages.push({ name: specialty, value: skillValue });
                        } else {
                            data.repeating_additionalskills.push({ name: skillName, value: skillValue });
                        }
                    } else {
                        data.repeating_additionalskills.push({ name: skillName, value: skillValue });
                    }
                }
            }

            let bioContent = `Name: ${character.name}\n\nTalents:\n`;
            if(character.archetype.talent) {
                 bioContent += `- ${character.archetype.talent} (Archetype): ${character.archetype.talentDesc}\n`;
                 data.repeating_talents.push({talent_name: `${character.archetype.talent} (Archetype)`, talent_description: character.archetype.talentDesc});
            }
            if(character.naturalTalent) {
                bioContent += `- ${character.naturalTalent.name} (Natural): ${character.naturalTalent.desc}\n`;
                data.repeating_talents.push({talent_name: `${character.naturalTalent.name} (Natural)`, talent_description: character.naturalTalent.desc});
            }
            character.talents.forEach(t => {
                bioContent += `- ${t.name}: ${t.desc}\n`;
                data.repeating_talents.push({talent_name: t.name, talent_description: t.desc});
            });
            
            let gmNotesContent = "Hindrances:\n";
            character.hindrances.forEach(h => gmNotesContent += `- ${h.name}: ${h.desc}\n`);

            data.bio = bioContent;
            data.gmnotes = gmNotesContent;
            
            return data;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
